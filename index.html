<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>PostureCare Pro ‚Äî Advanced Posture Management</title>

  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800;900&family=Space+Grotesk:wght@400;500;600;700&display=swap" rel="stylesheet">

  <!-- Three.js Library -->
  <script src="https://cdn.jsdelivr.net/npm/three@0.160.0/build/three.min.js"></script>

  <style>
    :root{
      --bg-dark: #050810;
      --bg-primary: #0A0E1A;
      --text-primary: rgba(255, 255, 255, 0.98);
      --text-secondary: rgba(255, 255, 255, 0.65);
      --text-muted: rgba(255, 255, 255, 0.40);
      
      --accent-cyan: #00F5D4;
      --accent-blue: #4F46E5;
      --accent-purple: #7C3AED;
      --accent-green: #10B981;
      
      --glow-cyan: rgba(0, 245, 212, 0.5);
      --glow-blue: rgba(79, 70, 229, 0.5);
      
      --border: rgba(255, 255, 255, 0.08);
    }

    * { 
      box-sizing: border-box; 
      margin: 0; 
      padding: 0; 
    }
    
    html {
      scroll-behavior: smooth;
    }

    body {
      font-family: "Inter", -apple-system, BlinkMacSystemFont, system-ui, sans-serif;
      background: var(--bg-dark);
      color: var(--text-primary);
      min-height: 100vh;
      overflow-x: hidden;
      line-height: 1.6;
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
    }

    /* HERO HEADER - Full Width */
    .hero {
      min-height: 100vh;
      display: flex;
      flex-direction: column;
      position: relative;
      background: 
        radial-gradient(circle at 20% 20%, rgba(79, 70, 229, 0.15) 0%, transparent 50%),
        radial-gradient(circle at 80% 80%, rgba(0, 245, 212, 0.08) 0%, transparent 50%),
        linear-gradient(180deg, #0A0E1A 0%, #050810 100%);
      overflow: hidden;
    }

    .hero::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      height: 1px;
      background: linear-gradient(90deg, 
        transparent, 
        var(--accent-cyan), 
        var(--accent-blue),
        transparent
      );
      opacity: 0.4;
    }

    /* TOP NAV */
    .top-nav {
      padding: clamp(20px, 4vh, 40px) clamp(20px, 5vw, 80px);
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 20px;
      z-index: 100;
      position: relative;
    }

    .logo {
      display: flex;
      flex-direction: column;
      gap: 4px;
    }

    .logo h1 {
      font-family: "Space Grotesk", sans-serif;
      font-size: clamp(24px, 4vw, 42px);
      font-weight: 800;
      letter-spacing: -0.03em;
      background: linear-gradient(135deg, var(--accent-cyan) 0%, var(--accent-blue) 50%, var(--accent-purple) 100%);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
      line-height: 1.1;
    }

    .logo .tagline {
      font-size: clamp(11px, 1.5vw, 14px);
      color: var(--text-muted);
      font-weight: 500;
      letter-spacing: 0.1em;
      text-transform: uppercase;
    }

    .nav-controls {
      display: flex;
      align-items: center;
      gap: 12px;
      flex-wrap: wrap;
    }

    .status-badge {
      display: inline-flex;
      align-items: center;
      gap: 10px;
      padding: 12px 20px;
      border-radius: 100px;
      border: 1px solid var(--border);
      background: rgba(255, 255, 255, 0.02);
      backdrop-filter: blur(20px);
      font-size: 13px;
      font-weight: 600;
      color: var(--text-secondary);
      transition: all 0.3s ease;
    }

    .status-badge:hover {
      background: rgba(255, 255, 255, 0.04);
      border-color: rgba(255, 255, 255, 0.12);
    }

    .status-dot {
      width: 8px;
      height: 8px;
      border-radius: 50%;
      background: rgba(255, 255, 255, 0.3);
      transition: all 0.3s ease;
    }

    .status-dot.connected {
      background: var(--accent-cyan);
      box-shadow: 0 0 20px var(--glow-cyan);
      animation: pulse-dot 2s cubic-bezier(0.4, 0, 0.6, 1) infinite;
    }

    @keyframes pulse-dot {
      0%, 100% { 
        box-shadow: 0 0 20px var(--glow-cyan);
        transform: scale(1);
      }
      50% { 
        box-shadow: 0 0 30px var(--glow-cyan);
        transform: scale(1.1);
      }
    }

    .btn {
      padding: 12px 28px;
      border-radius: 100px;
      border: 1px solid var(--border);
      background: rgba(255, 255, 255, 0.03);
      color: var(--text-primary);
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      font-family: inherit;
      white-space: nowrap;
    }

    .btn:hover {
      transform: translateY(-2px);
      background: rgba(255, 255, 255, 0.06);
      border-color: rgba(255, 255, 255, 0.15);
      box-shadow: 0 10px 40px rgba(0, 0, 0, 0.3);
    }

    .btn:active {
      transform: translateY(0);
    }

    .btn-primary {
      background: linear-gradient(135deg, var(--accent-blue), var(--accent-purple));
      border: none;
      box-shadow: 0 4px 20px rgba(79, 70, 229, 0.3);
    }

    .btn-primary:hover {
      box-shadow: 0 8px 35px rgba(79, 70, 229, 0.5);
    }

    /* HERO 3D SECTION */
    .hero-3d {
      flex: 1;
      display: flex;
      align-items: center;
      justify-content: center;
      position: relative;
      padding: clamp(40px, 5vh, 80px) clamp(20px, 5vw, 80px);
    }

    .scene-container {
      width: 100%;
      max-width: 1400px;
      position: relative;
    }

    .scene-title-wrapper {
      text-align: center;
      margin-bottom: clamp(30px, 5vh, 60px);
      animation: fadeInUp 0.8s ease-out;
    }

    @keyframes fadeInUp {
      from {
        opacity: 0;
        transform: translateY(30px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    .scene-title {
      font-family: "Space Grotesk", sans-serif;
      font-size: clamp(32px, 6vw, 72px);
      font-weight: 800;
      letter-spacing: -0.03em;
      line-height: 1.1;
      margin-bottom: 16px;
      background: linear-gradient(135deg, 
        var(--text-primary) 0%, 
        var(--text-secondary) 100%
      );
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }

    .scene-subtitle {
      font-size: clamp(14px, 2vw, 18px);
      color: var(--text-muted);
      font-weight: 500;
      letter-spacing: 0.05em;
    }

    .canvas-wrapper {
      position: relative;
      border-radius: 40px;
      overflow: hidden;
      background: rgba(255, 255, 255, 0.02);
      border: 1px solid var(--border);
      backdrop-filter: blur(40px);
      box-shadow: 0 30px 100px rgba(0, 0, 0, 0.6);
    }

    #canvas3d {
      display: block;
      width: 100%;
      height: clamp(400px, 65vh, 700px);
      cursor: grab;
    }

    #canvas3d:active {
      cursor: grabbing;
    }

    /* IMU STATUS OVERLAYS */
    .imu-overlays {
      position: absolute;
      top: clamp(60px, 10%, 100px);
      left: 0;
      right: 0;
      display: flex;
      justify-content: space-around;
      padding: 0 clamp(30px, 5vw, 80px);
      pointer-events: none;
      z-index: 10;
      gap: 30px;
    }

    .imu-status {
      background: rgba(5, 8, 16, 0.92);
      border: 1px solid var(--border);
      border-radius: 24px;
      padding: clamp(16px, 2.5vw, 24px) clamp(20px, 3vw, 32px);
      backdrop-filter: blur(30px) saturate(180%);
      box-shadow: 0 10px 50px rgba(0, 0, 0, 0.6);
      min-width: clamp(160px, 20vw, 240px);
      display: flex;
      flex-direction: column;
      gap: 12px;
      transition: all 0.4s ease;
    }

    .imu-status.left {
      border-color: rgba(0, 245, 212, 0.3);
      background: linear-gradient(135deg, rgba(0, 245, 212, 0.06), rgba(5, 8, 16, 0.92));
    }

    .imu-status.right {
      border-color: rgba(79, 70, 229, 0.3);
      background: linear-gradient(135deg, rgba(79, 70, 229, 0.06), rgba(5, 8, 16, 0.92));
    }

    .imu-label {
      font-size: clamp(10px, 1.2vw, 12px);
      font-weight: 800;
      text-transform: uppercase;
      letter-spacing: 0.1em;
      opacity: 0.6;
    }

    .imu-activity {
      display: flex;
      align-items: center;
      gap: 10px;
      font-size: clamp(14px, 1.8vw, 18px);
      font-weight: 700;
    }

    .activity-dot {
      width: 10px;
      height: 10px;
      border-radius: 50%;
      background: rgba(255, 255, 255, 0.3);
      transition: all 0.3s ease;
    }

    .activity-dot.active {
      background: var(--accent-green);
      box-shadow: 0 0 20px rgba(16, 185, 129, 0.7);
      animation: pulse-activity 1.5s ease-in-out infinite;
    }

    @keyframes pulse-activity {
      0%, 100% { 
        box-shadow: 0 0 20px rgba(16, 185, 129, 0.7);
      }
      50% { 
        box-shadow: 0 0 30px rgba(16, 185, 129, 0.9);
      }
    }

    /* CONTENT SECTIONS */
    .section {
      padding: clamp(60px, 10vh, 120px) clamp(20px, 5vw, 80px);
      max-width: 1600px;
      margin: 0 auto;
      width: 100%;
    }

    .section-header {
      text-align: center;
      margin-bottom: clamp(40px, 8vh, 80px);
    }

    .section-title {
      font-family: "Space Grotesk", sans-serif;
      font-size: clamp(28px, 5vw, 56px);
      font-weight: 800;
      letter-spacing: -0.02em;
      line-height: 1.2;
      margin-bottom: 16px;
      background: linear-gradient(135deg, 
        var(--text-primary) 0%, 
        var(--text-secondary) 100%
      );
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }

    .section-subtitle {
      font-size: clamp(14px, 1.8vw, 18px);
      color: var(--text-muted);
      font-weight: 500;
    }

    /* DATA GRID */
    .data-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
      gap: clamp(20px, 3vw, 32px);
      margin-bottom: clamp(40px, 6vh, 60px);
    }

    .data-card {
      padding: clamp(28px, 4vw, 40px);
      border-radius: 32px;
      border: 1px solid var(--border);
      background: rgba(255, 255, 255, 0.02);
      backdrop-filter: blur(40px);
      box-shadow: 0 20px 70px rgba(0, 0, 0, 0.4);
      display: flex;
      flex-direction: column;
      gap: clamp(16px, 2.5vh, 24px);
      transition: all 0.4s ease;
    }

    .data-card:hover {
      transform: translateY(-5px);
      box-shadow: 0 30px 90px rgba(0, 0, 0, 0.5);
      border-color: rgba(255, 255, 255, 0.12);
    }

    .data-label {
      font-size: clamp(11px, 1.3vw, 14px);
      font-weight: 800;
      text-transform: uppercase;
      letter-spacing: 0.1em;
      color: var(--text-muted);
    }

    .data-value {
      font-family: "Space Grotesk", sans-serif;
      font-size: clamp(42px, 6vw, 64px);
      font-weight: 900;
      line-height: 1;
      letter-spacing: -0.02em;
      background: linear-gradient(135deg, var(--text-primary), var(--text-secondary));
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }

    .data-unit {
      font-size: clamp(16px, 2vw, 20px);
      font-weight: 700;
      color: var(--text-muted);
      margin-left: 8px;
    }

    .data-bar {
      width: 100%;
      height: 10px;
      border-radius: 100px;
      background: rgba(255, 255, 255, 0.05);
      overflow: hidden;
    }

    .data-bar-fill {
      height: 100%;
      width: 0%;
      border-radius: 100px;
      background: linear-gradient(90deg, var(--accent-cyan), var(--accent-blue));
      transition: width 0.5s cubic-bezier(0.4, 0, 0.2, 1);
      box-shadow: 0 0 20px var(--glow-cyan);
    }

    .data-detail {
      font-size: clamp(11px, 1.3vw, 13px);
      color: var(--text-muted);
      font-weight: 500;
      line-height: 1.5;
    }

    /* BATTERY SECTION - Calculator Style */
    .battery-calculator {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(320px, 1fr));
      gap: clamp(24px, 4vw, 40px);
      align-items: start;
    }

    .battery-inputs {
      display: flex;
      flex-direction: column;
      gap: clamp(20px, 3vh, 28px);
    }

    .input-group {
      display: flex;
      flex-direction: column;
      gap: 12px;
    }

    .input-label {
      font-size: clamp(12px, 1.4vw, 15px);
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: 0.08em;
      color: var(--text-secondary);
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .input-icon {
      font-size: clamp(16px, 2vw, 20px);
    }

    .input-field {
      padding: clamp(14px, 2vw, 18px) clamp(18px, 2.5vw, 24px);
      border-radius: 20px;
      border: 1px solid var(--border);
      background: rgba(255, 255, 255, 0.03);
      color: var(--text-primary);
      font-size: clamp(16px, 2vw, 20px);
      font-weight: 600;
      font-family: "Space Grotesk", sans-serif;
      transition: all 0.3s ease;
      outline: none;
    }

    .input-field:focus {
      border-color: var(--accent-cyan);
      background: rgba(255, 255, 255, 0.05);
      box-shadow: 0 0 0 3px rgba(0, 245, 212, 0.1);
    }

    .input-field:hover {
      border-color: rgba(255, 255, 255, 0.15);
    }

    .input-hint {
      font-size: clamp(11px, 1.2vw, 13px);
      color: var(--text-muted);
      font-weight: 500;
      font-style: italic;
    }

    .battery-result {
      padding: clamp(32px, 5vw, 48px);
      border-radius: 32px;
      border: 1px solid var(--border);
      background: rgba(255, 255, 255, 0.02);
      backdrop-filter: blur(40px);
      box-shadow: 0 30px 100px rgba(0, 0, 0, 0.5);
      display: flex;
      flex-direction: column;
      gap: clamp(20px, 3vh, 28px);
      position: relative;
      overflow: hidden;
      transition: all 0.4s ease;
    }

    .battery-result::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      height: 4px;
      background: linear-gradient(90deg, var(--accent-green), var(--accent-cyan));
      opacity: 1;
      transition: background 0.5s ease;
    }

    .battery-result.low::before {
      background: linear-gradient(90deg, var(--accent-cyan), #F59E0B, #EF4444);
    }

    .battery-result:hover {
      transform: translateY(-3px);
      box-shadow: 0 40px 120px rgba(0, 0, 0, 0.6);
      border-color: rgba(255, 255, 255, 0.12);
    }

    .battery-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
    }

    .battery-label-small {
      font-size: clamp(11px, 1.3vw, 14px);
      font-weight: 800;
      text-transform: uppercase;
      letter-spacing: 0.1em;
      color: var(--text-muted);
    }

    .battery-icon {
      font-size: clamp(28px, 4vw, 40px);
      opacity: 0.6;
      filter: grayscale(0.3);
    }

    .battery-percentage {
      font-family: "Space Grotesk", sans-serif;
      font-size: clamp(56px, 10vw, 96px);
      font-weight: 900;
      line-height: 1;
      letter-spacing: -0.03em;
      background: linear-gradient(135deg, var(--accent-green), var(--accent-cyan));
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
      transition: all 0.5s ease;
    }

    .battery-percentage.low {
      background: linear-gradient(135deg, #F59E0B, #EF4444);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }

    .battery-bar-wrapper {
      width: 100%;
      height: 16px;
      border-radius: 100px;
      background: rgba(255, 255, 255, 0.05);
      overflow: hidden;
      position: relative;
      box-shadow: inset 0 2px 10px rgba(0, 0, 0, 0.3);
    }

    .battery-bar {
      height: 100%;
      border-radius: 100px;
      background: linear-gradient(90deg, var(--accent-green), var(--accent-cyan));
      transition: width 0.6s cubic-bezier(0.4, 0, 0.2, 1);
      box-shadow: 0 0 30px var(--glow-cyan);
      position: relative;
    }

    .battery-bar.low {
      background: linear-gradient(90deg, #EF4444, #F59E0B);
      box-shadow: 0 0 30px rgba(239, 68, 68, 0.5);
    }

    .battery-bar::after {
      content: '';
      position: absolute;
      top: 0;
      right: 0;
      width: 60px;
      height: 100%;
      background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.4));
      animation: shimmer 2.5s infinite;
    }

    @keyframes shimmer {
      0% { transform: translateX(-100%); }
      100% { transform: translateX(100%); }
    }

    .battery-time-display {
      font-size: clamp(16px, 2.2vw, 24px);
      color: var(--text-primary);
      font-weight: 700;
      display: flex;
      align-items: center;
      gap: 10px;
      padding: clamp(12px, 2vh, 16px) clamp(16px, 2.5vw, 20px);
      border-radius: 16px;
      background: rgba(255, 255, 255, 0.03);
      border: 1px solid var(--border);
    }

    .battery-stats {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 12px;
      font-size: clamp(11px, 1.3vw, 13px);
      color: var(--text-muted);
    }

    .battery-stat {
      padding: 8px 12px;
      border-radius: 12px;
      background: rgba(255, 255, 255, 0.02);
      font-weight: 600;
    }

    .battery-stat span {
      color: var(--accent-cyan);
      font-weight: 700;
    }

    .battery-note {
      font-size: clamp(12px, 1.4vw, 14px);
      color: var(--text-muted);
      text-align: center;
      margin-top: clamp(20px, 3vh, 30px);
      font-weight: 500;
      line-height: 1.6;
    }

    .battery-note b {
      color: var(--accent-cyan);
      font-weight: 700;
    }

    /* FOOTER */
    .footer {
      padding: clamp(40px, 6vh, 60px) clamp(20px, 5vw, 80px);
      border-top: 1px solid var(--border);
      text-align: center;
      color: var(--text-muted);
      font-size: clamp(12px, 1.4vw, 14px);
    }

    /* RESPONSIVE */
    @media (max-width: 768px) {
      .nav-controls {
        width: 100%;
        justify-content: center;
      }

      .top-nav {
        flex-direction: column;
        text-align: center;
        gap: 20px;
      }

      .imu-overlays {
        flex-direction: column;
        align-items: center;
        gap: 16px;
        top: 40px;
      }

      .data-grid, .battery-calculator {
        grid-template-columns: 1fr;
      }

      .battery-stats {
        grid-template-columns: 1fr;
      }
    }

    /* SCROLL ANIMATIONS */
    @keyframes fadeIn {
      from { opacity: 0; }
      to { opacity: 1; }
    }

    .fade-in {
      animation: fadeIn 0.8s ease-out;
    }
  </style>
</head>

<body>
  <!-- HERO SECTION -->
  <section class="hero">
    <!-- TOP NAV -->
    <nav class="top-nav">
      <div class="logo">
        <h1>PostureCare Pro</h1>
        <div class="tagline">Advanced Posture Management</div>
      </div>

      <div class="nav-controls">
        <div class="status-badge">
          <span id="statusDot" class="status-dot"></span>
          <span id="statusText">Disconnected</span>
        </div>
        <div class="status-badge">
          <span id="lastUpdate">‚Äî</span>
        </div>
        <button class="btn btn-primary" onclick="connectBLE()">Connect Device</button>
        <button class="btn" onclick="demoMode()">Demo</button>
      </div>
    </nav>

    <!-- 3D VISUALIZATION -->
    <div class="hero-3d">
      <div class="scene-container">
        <div class="scene-title-wrapper">
          <h2 class="scene-title">Real-Time<br>Shoulder Tracking</h2>
          <p class="scene-subtitle">Interactive 3D Visualization ‚Ä¢ Drag to Rotate ‚Ä¢ Scroll to Zoom</p>
        </div>

        <div class="canvas-wrapper">
          <canvas id="canvas3d"></canvas>
          
          <!-- IMU Status Overlays -->
          <div class="imu-overlays">
            <div class="imu-status left">
              <div class="imu-label">IMU0 ‚Ä¢ Left Shoulder</div>
              <div class="imu-activity">
                <span class="activity-dot" id="dot-imu0"></span>
                <span id="status-imu0">Inactive</span>
              </div>
            </div>
            <div class="imu-status right">
              <div class="imu-label">IMU1 ‚Ä¢ Right Shoulder</div>
              <div class="imu-activity">
                <span class="activity-dot" id="dot-imu1"></span>
                <span id="status-imu1">Inactive</span>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </section>

  <!-- SENSOR DATA SECTION -->
  <section class="section">
    <div class="section-header">
      <h2 class="section-title">Live Sensor Data</h2>
      <p class="section-subtitle">Strap pressure and motion analytics</p>
    </div>

    <div class="data-grid">
      <!-- Pressure Left -->
      <div class="data-card">
        <div class="data-label">Left Strap Pressure</div>
        <div>
          <span id="pressureL" class="data-value">0</span>
          <span class="data-unit">units</span>
        </div>
        <div class="data-bar">
          <div id="pressureBarL" class="data-bar-fill"></div>
        </div>
      </div>

      <!-- Pressure Right -->
      <div class="data-card">
        <div class="data-label">Right Strap Pressure</div>
        <div>
          <span id="pressureR" class="data-value">0</span>
          <span class="data-unit">units</span>
        </div>
        <div class="data-bar">
          <div id="pressureBarR" class="data-bar-fill"></div>
        </div>
      </div>

      <!-- IMU0 Motion -->
      <div class="data-card">
        <div class="data-label">IMU0 ‚Ä¢ Left Motion</div>
        <div>
          <span id="imu0Mag" class="data-value">0.0</span>
          <span class="data-unit">Œî¬∞</span>
        </div>
        <div class="data-detail">
          R: <span id="imu0-r">‚Äî</span> ‚Ä¢ 
          P: <span id="imu0-p">‚Äî</span> ‚Ä¢ 
          Y: <span id="imu0-y">‚Äî</span>
        </div>
      </div>

      <!-- IMU1 Motion -->
      <div class="data-card">
        <div class="data-label">IMU1 ‚Ä¢ Right Motion</div>
        <div>
          <span id="imu1Mag" class="data-value">0.0</span>
          <span class="data-unit">Œî¬∞</span>
        </div>
        <div class="data-detail">
          R: <span id="imu1-r">‚Äî</span> ‚Ä¢ 
          P: <span id="imu1-p">‚Äî</span> ‚Ä¢ 
          Y: <span id="imu1-y">‚Äî</span>
        </div>
      </div>
    </div>
  </section>

  <!-- BATTERY SECTION - MOVED BELOW SENSOR DATA -->
  <section class="section" style="padding-top: 0;">
    <div class="section-header">
      <h2 class="section-title">Estimated Battery Life</h2>
      <p class="section-subtitle">Calculate remaining runtime based on capacity and consumption</p>
    </div>

    <div class="battery-calculator">
      <!-- LEFT: Input Controls -->
      <div class="battery-inputs">
        <div class="input-group">
          <label class="input-label">
            <span class="input-icon">üîã</span>
            Battery Capacity
          </label>
          <input 
            type="number" 
            id="batteryCapacity" 
            class="input-field" 
            value="2000" 
            min="100" 
            max="10000"
            step="100"
            oninput="calculateBattery()"
          />
          <div class="input-hint">Total battery capacity in mAh (typical: 1000-5000 mAh)</div>
        </div>

        <div class="input-group">
          <label class="input-label">
            <span class="input-icon">‚ö°</span>
            Current Consumption
          </label>
          <input 
            type="number" 
            id="currentConsumption" 
            class="input-field" 
            value="50" 
            min="1" 
            max="500"
            step="5"
            oninput="calculateBattery()"
          />
          <div class="input-hint">Average current draw in mA (typical: 20-150 mA)</div>
        </div>

        <div class="input-group">
          <label class="input-label">
            <span class="input-icon">üìä</span>
            Current Battery Level
          </label>
          <input 
            type="number" 
            id="batteryLevel" 
            class="input-field" 
            value="88" 
            min="0" 
            max="100"
            step="1"
            oninput="calculateBattery()"
          />
          <div class="input-hint">Current charge percentage (0-100%)</div>
        </div>
      </div>

      <!-- RIGHT: Calculated Results -->
      <div class="battery-result" id="battery-card">
        <div class="battery-header">
          <div class="battery-label-small">Remaining Charge</div>
          <div class="battery-icon">‚ö°</div>
        </div>
        
        <div>
          <span id="battery-percentage" class="battery-percentage">88</span>%
        </div>
        
        <div class="battery-bar-wrapper">
          <div id="battery-bar" class="battery-bar" style="width: 88%"></div>
        </div>
        
        <div class="battery-time-display">
          üïê <span id="battery-time">35h 12min remaining</span>
        </div>

        <div class="battery-stats">
          <div class="battery-stat">
            Capacity: <span id="stat-capacity">2000 mAh</span>
          </div>
          <div class="battery-stat">
            Usage: <span id="stat-usage">50 mA</span>
          </div>
          <div class="battery-stat">
            Remaining: <span id="stat-remaining">1760 mAh</span>
          </div>
          <div class="battery-stat">
            Total: <span id="stat-total">40h 0min</span>
          </div>
        </div>
      </div>
    </div>
    
    <p class="battery-note">
      Formula: <b>Remaining Time = (Capacity √ó Battery% / 100) √∑ Current Consumption</b><br>
      Adjust capacity and consumption values based on your specific hardware setup
    </p>
  </section>

  <!-- FOOTER -->
  <footer class="footer">
    <p>PostureCare Pro ¬© 2025 ‚Ä¢ Advanced Posture Management System</p>
  </footer>

<script>
  console.log("üöÄ PostureCare Pro v6.0 - Battery Calculator Edition");

  /* CONFIGURATION */
  const NUS_SERVICE_UUID = "6e400001-b5a3-f393-e0a9-e50e24dcca9e";
  const NUS_TX_CHAR_UUID = "6e400003-b5a3-f393-e0a9-e50e24dcca9e";
  const PRESSURE_MAX = 400;
  const ANGLE_DELTA_THRESHOLD = 5.0;
  const PULSE_MS = 2000;
  const ACTIVITY_TIMEOUT = 3000;

  /* STATE */
  const state = {
    connected: false,
    lastUpdate: null,
    pressure0: null, 
    pressure1: null,
    pressureFallbackSingle: false,
    imu0: { roll:null, pitch:null, yaw:null, lastDelta:null, lastActiveTime: 0 },
    imu1: { roll:null, pitch:null, yaw:null, lastDelta:null, lastActiveTime: 0 },
    ref0: null,
    ref1: null,
    battery: {
      capacity: 2000,      // mAh
      consumption: 50,     // mA
      level: 88            // percentage
    }
  };

  /* BATTERY CALCULATION */
  function calculateBattery() {
    // Get input values
    const capacity = parseFloat(document.getElementById('batteryCapacity').value) || 0;
    const consumption = parseFloat(document.getElementById('currentConsumption').value) || 1;
    const level = parseFloat(document.getElementById('batteryLevel').value) || 0;

    // Update state
    state.battery.capacity = capacity;
    state.battery.consumption = consumption;
    state.battery.level = Math.max(0, Math.min(100, level));

    // Calculate remaining capacity
    const remainingCapacity = (capacity * level) / 100;

    // Calculate time remaining (hours)
    const hoursRemaining = remainingCapacity / consumption;
    const hours = Math.floor(hoursRemaining);
    const minutes = Math.round((hoursRemaining - hours) * 60);

    // Calculate total possible runtime
    const totalHours = capacity / consumption;
    const totalHoursInt = Math.floor(totalHours);
    const totalMinutes = Math.round((totalHours - totalHoursInt) * 60);

    // Update display
    document.getElementById('battery-percentage').textContent = Math.round(level);
    document.getElementById('battery-bar').style.width = level + '%';
    
    // Format time display
    let timeDisplay;
    if (level < 1) {
      timeDisplay = 'Battery depleted';
    } else if (hoursRemaining < 0.1) {
      timeDisplay = 'Less than 6min remaining';
    } else if (hoursRemaining < 1) {
      timeDisplay = `${minutes}min remaining`;
    } else {
      timeDisplay = `${hours}h ${minutes}min remaining`;
    }
    document.getElementById('battery-time').textContent = timeDisplay;

    // Update stats
    document.getElementById('stat-capacity').textContent = `${Math.round(capacity)} mAh`;
    document.getElementById('stat-usage').textContent = `${Math.round(consumption)} mA`;
    document.getElementById('stat-remaining').textContent = `${Math.round(remainingCapacity)} mAh`;
    document.getElementById('stat-total').textContent = `${totalHoursInt}h ${totalMinutes}min`;

    // Update styling based on battery level
    const card = document.getElementById('battery-card');
    const percentage = document.getElementById('battery-percentage');
    const bar = document.getElementById('battery-bar');
    
    if (level < 20) {
      card.classList.add('low');
      percentage.classList.add('low');
      bar.classList.add('low');
    } else {
      card.classList.remove('low');
      percentage.classList.remove('low');
      bar.classList.remove('low');
    }
  }

  /* THREE.JS VARIABLES */
  let scene, camera, renderer, leftShoulder, rightShoulder, humanBody, animationId;
  let mouseDown = false, mouseX = 0, mouseY = 0;

  /* INIT 3D SCENE */
  function init3DScene() {
    console.log("üé¨ Initializing 3D Scene...");
    
    try {
      const canvas = document.getElementById('canvas3d');
      const width = canvas.clientWidth;
      const height = canvas.clientHeight;

      scene = new THREE.Scene();
      scene.background = new THREE.Color(0x0A0E1A);
      scene.fog = new THREE.FogExp2(0x0A0E1A, 0.016);

      camera = new THREE.PerspectiveCamera(38, width / height, 0.1, 1000);
      camera.position.set(0, 5.5, 13);
      camera.lookAt(0, 4.5, 0);

      renderer = new THREE.WebGLRenderer({ 
        canvas: canvas, 
        antialias: true,
        alpha: true,
        powerPreference: "high-performance"
      });
      renderer.setSize(width, height);
      renderer.setPixelRatio(Math.min(window.devicePixelRatio, 2));
      renderer.shadowMap.enabled = true;
      renderer.shadowMap.type = THREE.PCFSoftShadowMap;
      renderer.toneMapping = THREE.ACESFilmicToneMapping;
      renderer.toneMappingExposure = 1.3;

      // LIGHTING
      const ambientLight = new THREE.AmbientLight(0xffffff, 0.65);
      scene.add(ambientLight);

      const keyLight = new THREE.DirectionalLight(0xffffff, 1.3);
      keyLight.position.set(6, 12, 9);
      keyLight.castShadow = true;
      keyLight.shadow.mapSize.width = 4096;
      keyLight.shadow.mapSize.height = 4096;
      scene.add(keyLight);

      const fillLight = new THREE.DirectionalLight(0x6495ED, 0.5);
      fillLight.position.set(-6, 6, -4);
      scene.add(fillLight);

      const rimLight = new THREE.DirectionalLight(0x00F5D4, 0.6);
      rimLight.position.set(0, 4, -10);
      scene.add(rimLight);

      const leftImuLight = new THREE.PointLight(0x00F5D4, 1, 6);
      leftImuLight.position.set(-1.5, 5.5, 1.5);
      scene.add(leftImuLight);

      const rightImuLight = new THREE.PointLight(0x4F46E5, 1, 6);
      rightImuLight.position.set(1.5, 5.5, 1.5);
      scene.add(rightImuLight);

      // GROUND
      const groundGeometry = new THREE.CircleGeometry(18, 64);
      const groundMaterial = new THREE.MeshStandardMaterial({ 
        color: 0x1a1f2e,
        roughness: 0.9,
        metalness: 0.1
      });
      const ground = new THREE.Mesh(groundGeometry, groundMaterial);
      ground.rotation.x = -Math.PI / 2;
      ground.position.y = 0;
      ground.receiveShadow = true;
      scene.add(ground);

      const gridHelper = new THREE.PolarGridHelper(18, 20, 10, 64, 0x00F5D4, 0x4F46E5);
      gridHelper.material.opacity = 0.06;
      gridHelper.material.transparent = true;
      gridHelper.position.y = 0.01;
      scene.add(gridHelper);

      buildHuman();

      canvas.addEventListener('mousedown', onMouseDown);
      canvas.addEventListener('mousemove', onMouseMove);
      canvas.addEventListener('mouseup', onMouseUp);
      canvas.addEventListener('wheel', onMouseWheel);
      canvas.addEventListener('touchstart', onTouchStart);
      canvas.addEventListener('touchmove', onTouchMove);
      canvas.addEventListener('touchend', onTouchEnd);
      window.addEventListener('resize', onWindowResize);

      animate();
      console.log("‚úÖ Scene ready!");

    } catch (error) {
      console.error("‚ùå Error:", error);
    }
  }

  /* BUILD HUMAN MODEL */
  function buildHuman() {
    humanBody = new THREE.Group();

    const skinMaterial = new THREE.MeshStandardMaterial({ 
      color: 0xe8b89a,
      roughness: 0.9,
      metalness: 0.02
    });

    const shirtMaterial = new THREE.MeshStandardMaterial({ 
      color: 0x2c3e50,
      roughness: 0.95,
      metalness: 0.02
    });

    const vestMaterial = new THREE.MeshStandardMaterial({ 
      color: 0x1a2332,
      roughness: 0.8,
      metalness: 0.12,
      transparent: true,
      opacity: 0.98
    });

    const strapMaterial = new THREE.MeshStandardMaterial({ 
      color: 0x0d1117,
      roughness: 0.65,
      metalness: 0.25
    });

    // HEAD
    const headGeometry = new THREE.SphereGeometry(0.6, 64, 64);
    const head = new THREE.Mesh(headGeometry, skinMaterial);
    head.position.y = 6.5;
    head.scale.set(0.95, 1.1, 1);
    head.castShadow = true;
    humanBody.add(head);

    // NECK
    const neckGeometry = new THREE.CylinderGeometry(0.3, 0.35, 0.8, 32);
    const neck = new THREE.Mesh(neckGeometry, skinMaterial);
    neck.position.y = 5.7;
    neck.castShadow = true;
    humanBody.add(neck);

    // TORSO
    const torsoGeometry = new THREE.CylinderGeometry(0.75, 0.95, 3, 64);
    const torso = new THREE.Mesh(torsoGeometry, shirtMaterial);
    torso.position.y = 4;
    torso.castShadow = true;
    torso.receiveShadow = true;
    humanBody.add(torso);

    // VEST
    const vestGeometry = new THREE.CylinderGeometry(0.8, 1, 3.1, 64);
    const vest = new THREE.Mesh(vestGeometry, vestMaterial);
    vest.position.y = 4;
    vest.castShadow = true;
    humanBody.add(vest);

    // STRAPS
    const strapGeometry = new THREE.BoxGeometry(0.2, 3, 0.08);
    
    const strapLeft = new THREE.Mesh(strapGeometry, strapMaterial);
    strapLeft.position.set(-0.55, 4, 0.8);
    strapLeft.castShadow = true;
    humanBody.add(strapLeft);

    const strapRight = new THREE.Mesh(strapGeometry, strapMaterial);
    strapRight.position.set(0.55, 4, 0.8);
    strapRight.castShadow = true;
    humanBody.add(strapRight);

    // HIPS
    const hipsGeometry = new THREE.CylinderGeometry(0.95, 0.9, 1.3, 64);
    const hips = new THREE.Mesh(hipsGeometry, shirtMaterial);
    hips.position.y = 2.1;
    hips.castShadow = true;
    humanBody.add(hips);

    // LEFT SHOULDER
    leftShoulder = new THREE.Group();

    const upperArmGeoL = new THREE.CylinderGeometry(0.32, 0.28, 2.5, 32);
    const upperArmL = new THREE.Mesh(upperArmGeoL, shirtMaterial);
    upperArmL.position.y = -1.25;
    upperArmL.castShadow = true;
    leftShoulder.add(upperArmL);

    const shoulderJointGeoL = new THREE.SphereGeometry(0.42, 64, 64);
    const shoulderJointL = new THREE.Mesh(shoulderJointGeoL, shirtMaterial);
    shoulderJointL.castShadow = true;
    leftShoulder.add(shoulderJointL);

    const imuGroupL = new THREE.Group();
    
    const imuCaseGeoL = new THREE.BoxGeometry(0.65, 0.6, 0.4);
    const imuCaseMatL = new THREE.MeshStandardMaterial({ 
      color: 0x00F5D4,
      roughness: 0.25,
      metalness: 0.85,
      emissive: 0x00F5D4,
      emissiveIntensity: 0.6
    });
    const imuCaseL = new THREE.Mesh(imuCaseGeoL, imuCaseMatL);
    imuCaseL.position.set(0, 0.4, 0.5);
    imuCaseL.castShadow = true;
    imuGroupL.add(imuCaseL);

    const ledGeoL = new THREE.SphereGeometry(0.07, 32, 32);
    const ledMatL = new THREE.MeshBasicMaterial({ color: 0x00F5D4 });
    const ledL = new THREE.Mesh(ledGeoL, ledMatL);
    ledL.position.set(0, 0.4, 0.71);
    imuGroupL.add(ledL);

    const glowGeoL = new THREE.SphereGeometry(0.75, 32, 32);
    const glowMatL = new THREE.MeshBasicMaterial({ 
      color: 0x00F5D4,
      transparent: true,
      opacity: 0.1
    });
    const glowL = new THREE.Mesh(glowGeoL, glowMatL);
    imuGroupL.add(glowL);

    leftShoulder.add(imuGroupL);
    leftShoulder.position.set(-1.2, 5.2, 0);
    humanBody.add(leftShoulder);

    // RIGHT SHOULDER
    rightShoulder = new THREE.Group();

    const upperArmGeoR = new THREE.CylinderGeometry(0.32, 0.28, 2.5, 32);
    const upperArmR = new THREE.Mesh(upperArmGeoR, shirtMaterial);
    upperArmR.position.y = -1.25;
    upperArmR.castShadow = true;
    rightShoulder.add(upperArmR);

    const shoulderJointGeoR = new THREE.SphereGeometry(0.42, 64, 64);
    const shoulderJointR = new THREE.Mesh(shoulderJointGeoR, shirtMaterial);
    shoulderJointR.castShadow = true;
    rightShoulder.add(shoulderJointR);

    const imuGroupR = new THREE.Group();
    
    const imuCaseGeoR = new THREE.BoxGeometry(0.65, 0.6, 0.4);
    const imuCaseMatR = new THREE.MeshStandardMaterial({ 
      color: 0x4F46E5,
      roughness: 0.25,
      metalness: 0.85,
      emissive: 0x4F46E5,
      emissiveIntensity: 0.6
    });
    const imuCaseR = new THREE.Mesh(imuCaseGeoR, imuCaseMatR);
    imuCaseR.position.set(0, 0.4, 0.5);
    imuCaseR.castShadow = true;
    imuGroupR.add(imuCaseR);

    const ledGeoR = new THREE.SphereGeometry(0.07, 32, 32);
    const ledMatR = new THREE.MeshBasicMaterial({ color: 0x4F46E5 });
    const ledR = new THREE.Mesh(ledGeoR, ledMatR);
    ledR.position.set(0, 0.4, 0.71);
    imuGroupR.add(ledR);

    const glowGeoR = new THREE.SphereGeometry(0.75, 32, 32);
    const glowMatR = new THREE.MeshBasicMaterial({ 
      color: 0x4F46E5,
      transparent: true,
      opacity: 0.1
    });
    const glowR = new THREE.Mesh(glowGeoR, glowMatR);
    imuGroupR.add(glowR);

    rightShoulder.add(imuGroupR);
    rightShoulder.position.set(1.2, 5.2, 0);
    humanBody.add(rightShoulder);

    humanBody.position.y = 0.5;
    scene.add(humanBody);
  }

  /* UPDATE ROTATIONS */
  function update3DRotations() {
    if (!leftShoulder || !rightShoulder) return;

    const now = Date.now();

    if (state.imu0.roll !== null && state.imu0.pitch !== null && state.imu0.yaw !== null) {
      const roll0 = THREE.MathUtils.degToRad(state.imu0.roll);
      const pitch0 = THREE.MathUtils.degToRad(state.imu0.pitch);
      const yaw0 = THREE.MathUtils.degToRad(state.imu0.yaw);
      
      leftShoulder.rotation.set(pitch0, yaw0, roll0, 'XYZ');

      const isActive = (now - state.imu0.lastActiveTime) < ACTIVITY_TIMEOUT;
      updateActivityStatus(0, isActive);
    }

    if (state.imu1.roll !== null && state.imu1.pitch !== null && state.imu1.yaw !== null) {
      const roll1 = THREE.MathUtils.degToRad(state.imu1.roll);
      const pitch1 = THREE.MathUtils.degToRad(state.imu1.pitch);
      const yaw1 = THREE.MathUtils.degToRad(state.imu1.yaw);
      
      rightShoulder.rotation.set(pitch1, yaw1, roll1, 'XYZ');

      const isActive = (now - state.imu1.lastActiveTime) < ACTIVITY_TIMEOUT;
      updateActivityStatus(1, isActive);
    }
  }

  function updateActivityStatus(idx, isActive) {
    const dotId = idx === 0 ? 'dot-imu0' : 'dot-imu1';
    const statusId = idx === 0 ? 'status-imu0' : 'status-imu1';
    
    const dot = document.getElementById(dotId);
    const statusText = document.getElementById(statusId);

    if (isActive) {
      dot.classList.add('active');
      statusText.textContent = 'Active';
      statusText.style.color = 'var(--accent-green)';
    } else {
      dot.classList.remove('active');
      statusText.textContent = 'Inactive';
      statusText.style.color = 'var(--text-muted)';
    }
  }

  function animate() {
    animationId = requestAnimationFrame(animate);
    update3DRotations();
    renderer.render(scene, camera);
  }

  /* MOUSE CONTROLS */
  function onMouseDown(e) { mouseDown = true; mouseX = e.clientX; mouseY = e.clientY; }
  function onMouseMove(e) {
    if (!mouseDown) return;
    const deltaX = e.clientX - mouseX;
    const deltaY = e.clientY - mouseY;
    camera.position.x += deltaX * 0.01;
    camera.position.y -= deltaY * 0.01;
    camera.lookAt(0, 4.5, 0);
    mouseX = e.clientX;
    mouseY = e.clientY;
  }
  function onMouseUp() { mouseDown = false; }
  function onMouseWheel(e) {
    e.preventDefault();
    camera.position.z += e.deltaY * 0.01;
    camera.position.z = Math.max(7, Math.min(22, camera.position.z));
  }

  let touchStartX = 0, touchStartY = 0;
  function onTouchStart(e) { if (e.touches.length === 1) { touchStartX = e.touches[0].clientX; touchStartY = e.touches[0].clientY; } }
  function onTouchMove(e) {
    e.preventDefault();
    if (e.touches.length === 1) {
      const deltaX = e.touches[0].clientX - touchStartX;
      const deltaY = e.touches[0].clientY - touchStartY;
      camera.position.x += deltaX * 0.01;
      camera.position.y -= deltaY * 0.01;
      camera.lookAt(0, 4.5, 0);
      touchStartX = e.touches[0].clientX;
      touchStartY = e.touches[0].clientY;
    }
  }
  function onTouchEnd() { touchStartX = 0; touchStartY = 0; }

  function onWindowResize() {
    const canvas = document.getElementById('canvas3d');
    const width = canvas.clientWidth;
    const height = canvas.clientHeight;
    camera.aspect = width / height;
    camera.updateProjectionMatrix();
    renderer.setSize(width, height);
  }

  /* UI FUNCTIONS */
  function setConnected(on) {
    state.connected = on;
    const dot = document.getElementById("statusDot");
    const txt = document.getElementById("statusText");
    if (on) {
      dot.classList.add("connected");
      txt.textContent = "Connected";
    } else {
      dot.classList.remove("connected");
      txt.textContent = "Disconnected";
    }
  }

  function setLastUpdate() {
    const now = new Date();
    state.lastUpdate = now;
    document.getElementById("lastUpdate").textContent = now.toLocaleTimeString();
  }

  function setPressure(side, value) {
    const valid = (value == null || Number.isNaN(value)) ? null : Number(value);
    if (side === "L") {
      document.getElementById("pressureL").textContent = valid == null ? 0 : Math.round(valid);
      const pct = valid == null ? 0 : Math.max(0, Math.min(100, (valid / PRESSURE_MAX) * 100));
      document.getElementById("pressureBarL").style.width = pct + "%";
    } else {
      document.getElementById("pressureR").textContent = valid == null ? 0 : Math.round(valid);
      const pct = valid == null ? 0 : Math.max(0, Math.min(100, (valid / PRESSURE_MAX) * 100));
      document.getElementById("pressureBarR").style.width = pct + "%";
    }
  }

  function setPressureSingleFallback(value) {
    state.pressureFallbackSingle = true;
    setPressure("L", value);
    setPressure("R", value);
  }

  function updateImuPanel(idx) {
    const imu = idx === 0 ? state.imu0 : state.imu1;
    document.getElementById(idx === 0 ? "imu0Mag" : "imu1Mag").textContent =
      imu.lastDelta == null ? "‚Äî" : imu.lastDelta.toFixed(1);

    document.getElementById(idx === 0 ? "imu0-r" : "imu1-r").textContent = 
      imu.roll == null ? "‚Äî" : imu.roll.toFixed(1) + "¬∞";
    document.getElementById(idx === 0 ? "imu0-p" : "imu1-p").textContent = 
      imu.pitch == null ? "‚Äî" : imu.pitch.toFixed(1) + "¬∞";
    document.getElementById(idx === 0 ? "imu0-y" : "imu1-y").textContent = 
      imu.yaw == null ? "‚Äî" : imu.yaw.toFixed(1) + "¬∞";
  }

  function computeDelta(a, b) {
    if (!a || !b) return null;
    const dr = (a.roll - b.roll);
    const dp = (a.pitch - b.pitch);
    const dy = (a.yaw - b.yaw);
    return Math.sqrt(dr*dr + dp*dp + dy*dy);
  }

  function maybeTriggerGlow(idx) {
    const imu = idx === 0 ? state.imu0 : state.imu1;
    const ref = idx === 0 ? state.ref0 : state.ref1;
    if (!ref || imu.roll == null || imu.pitch == null || imu.yaw == null) return;

    const delta = computeDelta(imu, ref);
    imu.lastDelta = delta;
    updateImuPanel(idx);

    if (delta != null && delta >= ANGLE_DELTA_THRESHOLD) {
      imu.lastActiveTime = Date.now();
      if (idx === 0) state.ref0 = { roll: imu.roll, pitch: imu.pitch, yaw: imu.yaw };
      else state.ref1 = { roll: imu.roll, pitch: imu.pitch, yaw: imu.yaw };
    }
  }

  /* BLE DATA PARSING */
  function handleKV(keyRaw, valueRaw) {
    if (!keyRaw) return;
    const key = String(keyRaw).trim().toLowerCase();
    const v = Number(String(valueRaw).trim());

    setLastUpdate();

    if (key === "pressure0" || key === "pressure") { 
      state.pressure0 = v; 
      state.pressureFallbackSingle = false; 
      setPressure("L", v); 
      return; 
    }
    if (key === "pressure1" || key === "pressure2") { 
      state.pressure1 = v; 
      state.pressureFallbackSingle = false; 
      setPressure("R", v); 
      return; 
    }

    // Battery level from device
    if (key === "battery" || key === "batterylevel") {
      state.battery.level = Math.max(0, Math.min(100, v));
      document.getElementById('batteryLevel').value = state.battery.level;
      calculateBattery();
      return;
    }

    const parseImu = (idx, axis) => {
      const imu = idx === 0 ? state.imu0 : state.imu1;
      imu[axis] = v;
      if (idx === 0 && !state.ref0) state.ref0 = { roll: imu.roll, pitch: imu.pitch, yaw: imu.yaw };
      if (idx === 1 && !state.ref1) state.ref1 = { roll: imu.roll, pitch: imu.pitch, yaw: imu.yaw };
      maybeTriggerGlow(idx);
    };

    if (key === "roll0")  return parseImu(0, "roll");
    if (key === "pitch0") return parseImu(0, "pitch");
    if (key === "yaw0")   return parseImu(0, "yaw");
    if (key === "roll1")  return parseImu(1, "roll");
    if (key === "pitch1") return parseImu(1, "pitch");
    if (key === "yaw1")   return parseImu(1, "yaw");
  }

  function handleIncomingMessage(raw) {
    const msg = String(raw || "");
    if (!msg.trim()) return;

    const re = /([A-Za-z][A-Za-z0-9_]*)\s*=\s*([-+]?\d*\.?\d+(?:e[-+]?\d+)?)/gi;
    let m, found = false;
    while ((m = re.exec(msg)) !== null) {
      found = true;
      handleKV(m[1], m[2]);
    }

    if (!found) {
      const i = msg.indexOf("=");
      if (i > 0) handleKV(msg.slice(0, i).trim(), msg.slice(i + 1).trim());
    }
  }

  /* WEB BLUETOOTH */
  async function connectBLE() {
    try {
      setConnected(false);
      const device = await navigator.bluetooth.requestDevice({
        acceptAllDevices: true,
        optionalServices: [NUS_SERVICE_UUID]
      });
      const server = await device.gatt.connect();
      const service = await server.getPrimaryService(NUS_SERVICE_UUID);
      const txChar = await service.getCharacteristic(NUS_TX_CHAR_UUID);
      await txChar.startNotifications();
      const decoder = new TextDecoder("utf-8");
      txChar.addEventListener("characteristicvaluechanged", (event) => {
        const msg = decoder.decode(event.target.value);
        handleIncomingMessage(msg);
      });
      setConnected(true);
    } catch (err) {
      setConnected(false);
      alert("BLE Error: " + (err?.message || err));
    }
  }

  /* DEMO MODE */
  let demoInterval = null;
  function demoMode() {
    if (demoInterval) { 
      clearInterval(demoInterval); 
      demoInterval = null; 
      return; 
    }

    let p = 120;
    let r0 = 0, p0 = 0, y0 = 0;
    let r1 = 0, p1 = 0, y1 = 0;

    demoInterval = setInterval(() => {
      p += (Math.random() - 0.5) * 18;
      p = Math.max(0, Math.min(PRESSURE_MAX, p));
      handleKV("Pressure", p.toFixed(0));

      const kick0 = Math.random() < 0.12 ? 28 : 3.5;
      const kick1 = Math.random() < 0.12 ? 26 : 3.2;

      r0 += (Math.random()-0.5)*kick0; 
      p0 += (Math.random()-0.5)*kick0; 
      y0 += (Math.random()-0.5)*kick0;
      r1 += (Math.random()-0.5)*kick1; 
      p1 += (Math.random()-0.5)*kick1; 
      y1 += (Math.random()-0.5)*kick1;

      r0 = Math.max(-50, Math.min(50, r0));
      p0 = Math.max(-50, Math.min(50, p0));
      y0 = Math.max(-50, Math.min(50, y0));
      r1 = Math.max(-50, Math.min(50, r1));
      p1 = Math.max(-50, Math.min(50, p1));
      y1 = Math.max(-50, Math.min(50, y1));

      handleKV("Roll0", r0.toFixed(2));
      handleKV("Pitch0", p0.toFixed(2));
      handleKV("Yaw0", y0.toFixed(2));
      handleKV("Roll1", r1.toFixed(2));
      handleKV("Pitch1", p1.toFixed(2));
      handleKV("Yaw1", y1.toFixed(2));

      // Simulate battery drain in demo
      state.battery.level = Math.max(5, state.battery.level - 0.02);
      document.getElementById('batteryLevel').value = state.battery.level;
      calculateBattery();
    }, 250);
  }

  /* INIT */
  window.addEventListener('DOMContentLoaded', () => {
    console.log("üéØ PostureCare Pro v6.0 Ready!");
    setConnected(false);
    calculateBattery(); // Initial calculation
    init3DScene();
  });
</script>
</body>
</html>
