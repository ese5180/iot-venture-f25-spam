name: nRF7002DK CI/CD Pipeline (v3.0.2)

on:
  push:
    branches: [main, develop, master]
  pull_request:
    branches: [main, develop, master]
  workflow_dispatch:

jobs:
  build:
    name: Build Firmware (NCS v3.0.2)
    runs-on: ubuntu-latest

    container:
      # Zephyr CI image with all toolchains pre-installed
      image: ghcr.io/zephyrproject-rtos/ci:v0.26.13
      options: --cpus 2
      env:
        CMAKE_PREFIX_PATH: /opt/toolchains

    steps:
      # Step 1: Checkout your repository into "project/"
      - name: üì• Checkout Repository
        uses: actions/checkout@v4
        with:
          path: project

      # Step 2: Initialize nRF Connect SDK v3.0.2 workspace
      - name: ‚ôªÔ∏è Initialize NCS v3.0.2 Workspace
        run: |
          west init -m https://github.com/nrfconnect/sdk-nrf --mr v3.0.2 ncs
          cd ncs
          west update --narrow -o=--depth=1
          west zephyr-export

      # Step 3: Install Python requirements
      - name: üì¶ Install Python Requirements
        run: |
          pip3 install -r ncs/zephyr/scripts/requirements.txt
          pip3 install -r ncs/nrf/scripts/requirements.txt
          pip3 install -r ncs/bootloader/mcuboot/scripts/requirements.txt

      # Step 4: Copy your project into the NCS workspace correctly
      - name: üìÇ Copy Project to Workspace
        run: |
          mkdir -p ncs/iot-venture-spam
          cp -r project/* ncs/iot-venture-spam/

      # Step 5: Build with sysbuild for nRF7002DK
      - name: üî® Build Firmware with Sysbuild (nRF7002DK)
        run: |
          cd ncs
          west build -b nrf7002dk/nrf5340/cpuapp --sysbuild iot-venture-spam -p always

      # Step 6: Generate memory reports (rom.json / ram.json)
      - name: üìä Generate Build Reports
        if: success()
        run: |
          cd ncs/build
          ninja rom_report ram_report

      # Step 7: Upload all firmware artifacts (sysbuild‚Äëaware)
      - name: üì¶ Upload Firmware Artifacts
        uses: actions/upload-artifact@v4
        if: success()
        with:
          name: firmware-nrf7002dk-${{ github.sha }}
          path: |
            ncs/build/**/zephyr/*.elf
            ncs/build/**/zephyr/*.hex
            ncs/build/**/zephyr/*.bin
            ncs/build/**/zephyr/app_update.bin
            ncs/build/**/merged.hex
          retention-days: 30

      # Step 8: Upload memory reports
      - name: üìà Upload Memory Reports
        uses: actions/upload-artifact@v4
        if: success()
        with:
          name: memory-reports-${{ github.sha }}
          path: |
            ncs/build/rom.json
            ncs/build/ram.json
          retention-days: 7

  code-quality:
    name: Code Quality Checks
    runs-on: ubuntu-latest

    steps:
      - name: üì• Checkout Repository
        uses: actions/checkout@v4

      - name: üîç Check for TODOs and FIXMEs
        run: |
          echo "Scanning for TODO/FIXME comments..."
          grep -rn "TODO\|FIXME" src/ || echo "No TODOs or FIXMEs found"

      - name: üìè Check File Sizes
        run: |
          echo "Checking for large files..."
          find . -type f -size +1M -not -path "./.git/*" -not -path "./images/*"
