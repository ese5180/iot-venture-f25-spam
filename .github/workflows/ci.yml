name: Build nRF7002DK Firmware

on:
  push:
    branches: [main, master, develop]
    paths-ignore:
      - 'docs/**'
      - '**.md'
  pull_request:
  workflow_dispatch:
    inputs:
      upload_to_memfault:
        description: 'Upload artifacts to Memfault'
        type: boolean
        default: false

env:
  NCS_VERSION: v3.0.2
  BOARD: nrf7002dk/nrf5340/cpuapp

jobs:
  build:
    name: Build ${{ matrix.app.name }}
    runs-on: ubuntu-24.04
    
    container:
      image: ghcr.io/zephyrproject-rtos/ci:v0.27.4
      options: --user root
    
    env:
      CMAKE_PREFIX_PATH: /opt/toolchains
    
    strategy:
      fail-fast: false
      matrix:
        app:
          - name: "Root Main App"
            path: "."
            build_name: "root-app"
          
          - name: "Motion Sensor"
            path: "subroutines/Motion_sensor"
            build_name: "motion-sensor"
          
          - name: "BLE NUS"
            path: "subroutines/ble_nus"
            build_name: "ble-nus"
          
          - name: "Servo"
            path: "subroutines/servo"
            build_name: "servo"

    steps:
      # ============================================================
      # Checkout
      # ============================================================
      - name: üì• Checkout Repository
        uses: actions/checkout@v4
        with:
          path: project
          fetch-depth: 0

      # ============================================================
      # Cache West Modules (Saves 5-10 minutes)
      # ============================================================
      - name: üíæ Cache West Modules
        id: cache-west
        uses: actions/cache@v4
        with:
          path: |
            modules
            zephyr
            nrf
            bootloader
            tools
          key: west-modules-${{ env.NCS_VERSION }}-${{ hashFiles('project/west.yml') }}
          restore-keys: |
            west-modules-${{ env.NCS_VERSION }}-
            west-modules-

      # ============================================================
      # Initialize West (with multi-core support)
      # ============================================================
      - name: üîß Initialize West Workspace
        working-directory: project
        run: |
          west init -l .
          
          if [ "${{ steps.cache-west.outputs.cache-hit }}" != "true" ]; then
            echo "üì¶ Fetching NCS modules (not cached)..."
            west update -o=--depth=1 -n
            west blobs fetch hal_nordic
          else
            echo "‚úÖ Using cached modules"
          fi
          
          west zephyr-export
          
          # Verify network core image is available
          echo "üîç Checking for network core samples..."
          ls -la ../zephyr/samples/bluetooth/hci_ipc 2>/dev/null || echo "‚ö†Ô∏è  Network core sample not found"

      # ============================================================
      # Python Dependencies
      # ============================================================
      - name: üì¶ Install Dependencies
        run: |
          pip3 install --no-cache-dir -r nrf/scripts/requirements-build.txt
          pip3 install --no-cache-dir -r zephyr/scripts/requirements.txt
          pip3 install --no-cache-dir -r bootloader/mcuboot/scripts/requirements.txt

      # ============================================================
      # Version Detection
      # ============================================================
      - name: üè∑Ô∏è Set Firmware Version
        id: version
        run: |
          if [[ "${{ github.ref }}" == refs/tags/v* ]]; then
            VERSION="${{ github.ref_name }}"
          else
            # Use short SHA for CI builds
            VERSION="$(git -C project rev-parse --short=8 HEAD)"
          fi
          echo "VERSION=$VERSION" >> $GITHUB_ENV
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "üìå Building version: $VERSION"

      # ============================================================
      # Memfault Configuration
      # ============================================================
      - name: üîê Configure Memfault
        working-directory: project/${{ matrix.app.path }}
        env:
          MEMFAULT_KEY: ${{ secrets.MEMFAULT_PROJECT_KEY }}
        run: |
          # Create Memfault overlay for CI
          cat > overlay-memfault-ci.conf << 'EOF'
          # ============ MEMFAULT CONFIGURATION ============
          CONFIG_MEMFAULT=y
          CONFIG_MEMFAULT_SHELL=y
          CONFIG_MEMFAULT_LOGGING_ENABLE=y
          CONFIG_MEMFAULT_LOG_LEVEL_INF=y
          CONFIG_MEMFAULT_NCS_BT_METRICS=y
          
          # Project identification
          CONFIG_MEMFAULT_NCS_PROJECT_KEY="${MEMFAULT_KEY}"
          CONFIG_MEMFAULT_NCS_FW_VERSION_STATIC=y
          CONFIG_MEMFAULT_NCS_FW_VERSION="${{ env.VERSION }}"
          CONFIG_MEMFAULT_NCS_FW_TYPE="ci-${{ matrix.app.build_name }}"
          CONFIG_MEMFAULT_NCS_DEVICE_ID_STATIC=y
          CONFIG_MEMFAULT_NCS_DEVICE_ID="ci-${{ matrix.app.build_name }}-dev01"
          
          # Disable hw_id to prevent networking dependency
          CONFIG_HW_ID_LIBRARY=n
          
          # Device Info Service (for nRF Device Manager OTA)
          CONFIG_BT_DIS=y
          CONFIG_BT_DIS_SERIAL_NUMBER=y
          CONFIG_BT_DIS_SERIAL_NUMBER_STR="ci-${{ matrix.app.build_name }}-dev01"
          CONFIG_BT_DIS_HW_REV=y
          CONFIG_BT_DIS_HW_REV_STR="nrf7002dk_nrf5340"
          CONFIG_BT_DIS_SW_REV=y
          CONFIG_BT_DIS_SW_REV_STR="main"
          CONFIG_BT_DIS_FW_REV=y
          CONFIG_BT_DIS_FW_REV_STR="${{ env.VERSION }}"
          EOF
          
          # Substitute environment variables
          envsubst < overlay-memfault-ci.conf > overlay-memfault-ci.conf.tmp
          mv overlay-memfault-ci.conf.tmp overlay-memfault-ci.conf
          
          echo "‚úÖ Memfault configuration created:"
          cat overlay-memfault-ci.conf

      # ============================================================
      # Build Firmware (with sysbuild for multi-core)
      # ============================================================
      - name: üî® Build ${{ matrix.app.name }}
        working-directory: project/${{ matrix.app.path }}
        run: |
          echo "============================================"
          echo "üèóÔ∏è  Building: ${{ matrix.app.name }}"
          echo "üìã Board: ${{ env.BOARD }}"
          echo "üè∑Ô∏è  Version: ${{ env.VERSION }}"
          echo "üîß Sysbuild: ENABLED (multi-core support)"
          echo "============================================"
          
          # Check if overlay exists
          EXTRA_CONF=""
          if [ -f overlay-memfault-ci.conf ]; then
            EXTRA_CONF="-DEXTRA_CONF_FILE=overlay-memfault-ci.conf"
            echo "‚úÖ Using Memfault overlay"
          fi
          
          # Build with sysbuild (critical for nRF5340 dual-core)
          set +e
          west build \
            -b ${{ env.BOARD }} \
            -p always \
            --sysbuild \
            -- $EXTRA_CONF \
            2>&1 | tee build.log
          
          BUILD_STATUS=$?
          set -e
          
          if [ $BUILD_STATUS -ne 0 ]; then
            echo "‚ùå BUILD FAILED"
            echo "::error::Build failed with exit code $BUILD_STATUS"
            exit $BUILD_STATUS
          fi
          
          echo "‚úÖ BUILD SUCCEEDED"
          
          # Verify multi-core images were built
          echo ""
          echo "üîç Verifying build artifacts:"
          if [ -d build ]; then
            find build -name "zephyr.elf" -o -name "merged.hex" | while read file; do
              echo "  ‚úì $file"
            done
          fi

      # ============================================================
      # Generate Reports & Rename Artifacts
      # ============================================================
      - name: üìã Process Artifacts
        if: success()
        working-directory: project/${{ matrix.app.path }}/build
        run: |
          echo "üì¶ Processing build artifacts..."
          
          # Sysbuild creates this structure:
          # build/
          # ‚îú‚îÄ‚îÄ <app_name>/         ‚Üê App core image
          # ‚îÇ   ‚îî‚îÄ‚îÄ zephyr/
          # ‚îú‚îÄ‚îÄ mcuboot/            ‚Üê Bootloader
          # ‚îú‚îÄ‚îÄ ipc_radio/          ‚Üê Network core (BLE controller)
          # ‚îÇ   ‚îî‚îÄ‚îÄ zephyr/
          # ‚îî‚îÄ‚îÄ merged.hex          ‚Üê Combined image (all cores)
          
          # Find app core build directory
          APP_DIR=$(find . -maxdepth 2 -type f -name "zephyr.elf" | head -n1 | xargs dirname | xargs dirname)
          if [ -z "$APP_DIR" ]; then
            echo "‚ö†Ô∏è  Could not find app directory, using current"
            APP_DIR="."
          fi
          
          echo "üìÇ App directory: $APP_DIR"
          cd "$APP_DIR"
          
          # Generate partition manager report
          if [ -f build.ninja ]; then
            ninja partition_manager_report > ../../pmr.txt 2>&1 || echo "‚ö†Ô∏è  PM report skipped"
            sed -i '1d' ../../pmr.txt 2>/dev/null || true
          fi
          
          # Generate memory report
          if [ -f zephyr/zephyr.elf ]; then
            echo "üìä Memory usage (App Core):"
            arm-zephyr-eabi-size zephyr/zephyr.elf | tee ../../memory-app.txt
          fi
          
          # Check network core image
          cd ../..
          if [ -d ipc_radio/zephyr ]; then
            echo "üìä Memory usage (Network Core - BLE Controller):"
            arm-zephyr-eabi-size ipc_radio/zephyr/zephyr.elf | tee memory-net.txt
          fi
          
          # Rename artifacts with version
          PREFIX="${{ matrix.app.build_name }}-${{ env.VERSION }}"
          
          # App core ELF/HEX
          [ -f "$APP_DIR/zephyr/zephyr.elf" ] && cp "$APP_DIR/zephyr/zephyr.elf" "${PREFIX}-app.elf"
          [ -f "$APP_DIR/zephyr/zephyr.hex" ] && cp "$APP_DIR/zephyr/zephyr.hex" "${PREFIX}-app.hex"
          
          # Merged hex (all cores + bootloader)
          [ -f merged.hex ] && cp merged.hex "${PREFIX}-merged.hex"
          
          # OTA/DFU files
          [ -f "$APP_DIR/zephyr/zephyr.signed.bin" ] && cp "$APP_DIR/zephyr/zephyr.signed.bin" "${PREFIX}-ota.bin"
          [ -f "$APP_DIR/zephyr/app_update.bin" ] && cp "$APP_DIR/zephyr/app_update.bin" "${PREFIX}-update.bin"
          [ -f dfu_application.zip ] && cp dfu_application.zip "${PREFIX}-dfu.zip"
          
          # Network core image (for reference)
          if [ -f ipc_radio/zephyr/zephyr.hex ]; then
            cp ipc_radio/zephyr/zephyr.hex "${PREFIX}-net.hex"
          fi
          
          echo ""
          echo "‚úÖ Artifacts prepared:"
          ls -lh ${PREFIX}-* 2>/dev/null || echo "‚ö†Ô∏è  No artifacts found"

      # ============================================================
      # Upload Logs on Failure
      # ============================================================
      - name: üì§ Upload Build Logs (Failure)
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: logs-${{ matrix.app.build_name }}-${{ github.run_number }}
          path: |
            project/${{ matrix.app.path }}/build.log
            project/${{ matrix.app.path }}/build/**/CMakeFiles/CMakeError.log
            project/${{ matrix.app.path }}/build/**/CMakeFiles/CMakeOutput.log
          retention-days: 7
          if-no-files-found: warn

      # ============================================================
      # Upload Firmware on Success
      # ============================================================
      - name: üì¶ Upload Firmware
        if: success()
        uses: actions/upload-artifact@v4
        with:
          name: firmware-${{ matrix.app.build_name }}-${{ github.run_number }}
          path: |
            project/${{ matrix.app.path }}/build/${{ matrix.app.build_name }}-${{ env.VERSION }}-*
            project/${{ matrix.app.path }}/build/pmr.txt
            project/${{ matrix.app.path }}/build/memory-*.txt
            project/${{ matrix.app.path }}/build.log
          retention-days: 30
          if-no-files-found: error

      # ============================================================
      # Build Summary
      # ============================================================
      - name: üìù Summary
        if: always()
        run: |
          cat >> $GITHUB_STEP_SUMMARY << 'EOF'
          ### ${{ matrix.app.name }} - Build ${{ job.status }}
          
          | Property | Value |
          |----------|-------|
          | **Board** | ${{ env.BOARD }} |
          | **Version** | `${{ env.VERSION }}` |
          | **NCS** | ${{ env.NCS_VERSION }} |
          | **Sysbuild** | ‚úÖ Enabled (App + Net cores) |
          | **Memfault** | ‚úÖ Configured |
          | **Status** | **${{ job.status }}** |
          | **Artifact** | `firmware-${{ matrix.app.build_name }}-${{ github.run_number }}` |
          
          #### Generated Files
          - `${{ matrix.app.build_name }}-${{ env.VERSION }}-merged.hex` - Flash this to device
          - `${{ matrix.app.build_name }}-${{ env.VERSION }}-ota.bin` - Use for BLE OTA updates
          - `${{ matrix.app.build_name }}-${{ env.VERSION }}-dfu.zip` - DFU package
          EOF
