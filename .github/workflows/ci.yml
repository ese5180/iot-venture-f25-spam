name: Build nRF7002DK Firmware

on:
  push:
    branches: [main, master, develop]
    paths-ignore:
      - 'docs/**'
      - '**.md'
      - 'LICENSE'
      - '.gitignore'
  pull_request:
    branches: [main, master, develop]
  workflow_dispatch:
    inputs:
      build_debug:
        description: 'Build debug variants'
        type: boolean
        default: false

env:
  NCS_VERSION: v3.0.2
  BOARD: nrf7002dk/nrf5340/cpuapp

jobs:
  build:
    name: Build ${{ matrix.app.name }}
    runs-on: ubuntu-24.04
    timeout-minutes: 60
    
    strategy:
      fail-fast: false
      matrix:
        app:
          - name: "Root Main App"
            path: "."
            build_name: "root-app"
          
          - name: "Motion Sensor"
            path: "subroutines/Motion_sensor"
            build_name: "motion-sensor"
          
          - name: "BLE NUS"
            path: "subroutines/ble_nus"
            build_name: "ble-nus"
          
          - name: "Servo"
            path: "subroutines/servo"
            build_name: "servo"

    steps:
      # ============================================================
      # STEP 1: Checkout code
      # ============================================================
      - name: ðŸ“¥ Checkout Repository
        uses: actions/checkout@v4
        with:
          path: project
          fetch-depth: 0

      # ============================================================
      # STEP 2: Cache NCS modules
      # ============================================================
      - name: ðŸ’¾ Cache West Modules
        id: cache-west
        uses: actions/cache@v4
        with:
          path: |
            modules
            zephyr
            nrf
            bootloader
            tools
          key: west-modules-${{ env.NCS_VERSION }}-${{ hashFiles('project/west.yml') }}
          restore-keys: |
            west-modules-${{ env.NCS_VERSION }}-
            west-modules-

      # ============================================================
      # STEP 3: Build in Docker container
      # ============================================================
      - name: ðŸ”§ Initialize & Build
        env:
          MEMFAULT_KEY: ${{ secrets.MEMFAULT_PROJECT_KEY }}
        run: |
          docker run --rm \
            -v "$(pwd):/workdir" \
            -w /workdir/project \
            -e MEMFAULT_KEY="${MEMFAULT_KEY}" \
            ghcr.io/zephyrproject-rtos/ci:v0.27.4 \
            bash -c '
              set -e
              export CMAKE_PREFIX_PATH=/opt/toolchains
              
              echo "============================================"
              echo "ðŸš€ CI/CD Build Pipeline"
              echo "============================================"
              echo "ðŸ“¦ NCS Version: ${{ env.NCS_VERSION }}"
              echo "ðŸ“‹ Board: ${{ env.BOARD }}"
              echo "ðŸ—ï¸  App: ${{ matrix.app.name }}"
              echo "ðŸ“‚ Path: ${{ matrix.app.path }}"
              echo "============================================"
              
              # Initialize west
              echo ""
              echo "ðŸ”§ Initializing West workspace..."
              west init -l .
              
              # Update modules (or use cache)
              if [ "${{ steps.cache-west.outputs.cache-hit }}" != "true" ]; then
                echo "ðŸ“¦ Fetching NCS modules (not cached)..."
                west update -o=--depth=1 -n
                west blobs fetch hal_nordic
              else
                echo "âœ… Using cached NCS modules"
              fi
              
              # Export Zephyr CMake package
              west zephyr-export
              
              # Verify workspace
              echo ""
              echo "âœ… Workspace initialized:"
              ls -1d */ | head -n 5
              
              # Install Python dependencies
              echo ""
              echo "ðŸ“¦ Installing Python dependencies..."
              pip3 install --no-cache-dir -q \
                -r ../nrf/scripts/requirements-build.txt \
                -r ../zephyr/scripts/requirements.txt \
                -r ../bootloader/mcuboot/scripts/requirements.txt
              
              # Set firmware version
              if [[ "${{ github.ref }}" == refs/tags/v* ]]; then
                VERSION="${{ github.ref_name }}"
              else
                VERSION="$(git rev-parse --short=8 HEAD)"
              fi
              echo "VERSION=$VERSION" >> /workdir/version.txt
              echo "ðŸ·ï¸  Firmware Version: $VERSION"
              
              # Navigate to app directory
              cd ${{ matrix.app.path }}
              
              # Create Memfault overlay
              echo ""
              echo "ðŸ” Configuring Memfault..."
              cat > overlay-memfault-ci.conf << "OVERLAY_EOF"
              # ============ MEMFAULT CONFIGURATION ============
              CONFIG_MEMFAULT=y
              CONFIG_MEMFAULT_SHELL=y
              CONFIG_MEMFAULT_LOGGING_ENABLE=y
              CONFIG_MEMFAULT_LOG_LEVEL_INF=y
              CONFIG_MEMFAULT_NCS_BT_METRICS=y
              
              # Project identification
              CONFIG_MEMFAULT_NCS_PROJECT_KEY="MEMFAULT_KEY_PLACEHOLDER"
              CONFIG_MEMFAULT_NCS_FW_VERSION_STATIC=y
              CONFIG_MEMFAULT_NCS_FW_VERSION="VERSION_PLACEHOLDER"
              CONFIG_MEMFAULT_NCS_FW_TYPE="ci-${{ matrix.app.build_name }}"
              CONFIG_MEMFAULT_NCS_DEVICE_ID_STATIC=y
              CONFIG_MEMFAULT_NCS_DEVICE_ID="ci-${{ matrix.app.build_name }}-dev01"
              
              # Disable hw_id to prevent networking dependency
              CONFIG_HW_ID_LIBRARY=n
              
              # Device Info Service (for OTA)
              CONFIG_BT_DIS=y
              CONFIG_BT_DIS_SERIAL_NUMBER=y
              CONFIG_BT_DIS_SERIAL_NUMBER_STR="ci-${{ matrix.app.build_name }}-dev01"
              CONFIG_BT_DIS_HW_REV=y
              CONFIG_BT_DIS_HW_REV_STR="nrf7002dk_nrf5340"
              CONFIG_BT_DIS_SW_REV=y
              CONFIG_BT_DIS_SW_REV_STR="main"
              CONFIG_BT_DIS_FW_REV=y
              CONFIG_BT_DIS_FW_REV_STR="VERSION_PLACEHOLDER"
              
              # MCUmgr for OTA
              CONFIG_MCUMGR_GRP_OS_INFO=y
              CONFIG_BT_SMP=y
              CONFIG_BT_SETTINGS=y
              
              # Flash & DFU settings
              CONFIG_FLASH_MAP=y
              CONFIG_STREAM_FLASH=y
              CONFIG_IMG_MANAGER=y
              CONFIG_DFU_TARGET=y
              CONFIG_DFU_TARGET_MCUBOOT=y
              
              # Heap for Memfault
              CONFIG_HEAP_MEM_POOL_SIZE=4096
              OVERLAY_EOF
              
              # Substitute placeholders
              sed -i "s/MEMFAULT_KEY_PLACEHOLDER/${MEMFAULT_KEY}/g" overlay-memfault-ci.conf
              sed -i "s/VERSION_PLACEHOLDER/$VERSION/g" overlay-memfault-ci.conf
              
              echo "âœ… Memfault overlay created"
              
              # Build firmware
              echo ""
              echo "============================================"
              echo "ðŸ”¨ Building ${{ matrix.app.name }}"
              echo "============================================"
              
              set +e
              west build \
                -b ${{ env.BOARD }} \
                -p always \
                --sysbuild \
                -- -DEXTRA_CONF_FILE=overlay-memfault-ci.conf \
                2>&1 | tee build.log
              
              BUILD_STATUS=$?
              set -e
              
              if [ $BUILD_STATUS -ne 0 ]; then
                echo ""
                echo "âŒ BUILD FAILED with exit code $BUILD_STATUS"
                echo "::error::Build failed for ${{ matrix.app.name }}"
                exit $BUILD_STATUS
              fi
              
              echo ""
              echo "âœ… BUILD SUCCEEDED"
              
              # Verify build artifacts
              echo ""
              echo "ðŸ” Verifying build artifacts..."
              if [ -d build ]; then
                find build -name "zephyr.elf" -o -name "merged.hex" | while read file; do
                  echo "  âœ“ Found: $file"
                done
              fi
              
              # Process artifacts
              echo ""
              echo "ðŸ“¦ Processing artifacts..."
              cd build
              
              # Find main app build directory (handles sysbuild structure)
              APP_DIR=$(find . -maxdepth 2 -type f -name "zephyr.elf" -print -quit | xargs dirname | xargs dirname)
              
              if [ -z "$APP_DIR" ]; then
                echo "âš ï¸  Warning: Could not find app directory, checking root..."
                APP_DIR="."
              fi
              
              echo "ðŸ“‚ App build directory: $APP_DIR"
              
              # Generate memory report
              if [ -d "$APP_DIR/zephyr" ] && [ -f "$APP_DIR/zephyr/zephyr.elf" ]; then
                echo ""
                echo "ðŸ“Š Memory usage (Application Core):"
                arm-zephyr-eabi-size "$APP_DIR/zephyr/zephyr.elf" | tee memory-app.txt
              fi
              
              # Check for network core
              if [ -d "ipc_radio/zephyr" ] && [ -f "ipc_radio/zephyr/zephyr.elf" ]; then
                echo ""
                echo "ðŸ“Š Memory usage (Network Core - BLE):"
                arm-zephyr-eabi-size "ipc_radio/zephyr/zephyr.elf" | tee memory-net.txt
              fi
              
              # Rename artifacts with version
              VERSION=$(cat /workdir/version.txt)
              PREFIX="${{ matrix.app.build_name }}-$VERSION"
              
              echo ""
              echo "ðŸ“ Renaming artifacts with version: $VERSION"
              
              # App core images
              if [ -f "$APP_DIR/zephyr/zephyr.elf" ]; then
                cp "$APP_DIR/zephyr/zephyr.elf" "${PREFIX}-app.elf"
                echo "  âœ“ ${PREFIX}-app.elf"
              fi
              
              if [ -f "$APP_DIR/zephyr/zephyr.hex" ]; then
                cp "$APP_DIR/zephyr/zephyr.hex" "${PREFIX}-app.hex"
                echo "  âœ“ ${PREFIX}-app.hex"
              fi
              
              # Merged image (all cores + bootloader)
              if [ -f "merged.hex" ]; then
                cp "merged.hex" "${PREFIX}-merged.hex"
                echo "  âœ“ ${PREFIX}-merged.hex (FLASH THIS TO DEVICE)"
              fi
              
              # OTA/DFU files
              if [ -f "$APP_DIR/zephyr/zephyr.signed.bin" ]; then
                cp "$APP_DIR/zephyr/zephyr.signed.bin" "${PREFIX}-ota.bin"
                echo "  âœ“ ${PREFIX}-ota.bin (OTA update file)"
              fi
              
              if [ -f "$APP_DIR/zephyr/app_update.bin" ]; then
                cp "$APP_DIR/zephyr/app_update.bin" "${PREFIX}-update.bin"
                echo "  âœ“ ${PREFIX}-update.bin"
              fi
              
              if [ -f "dfu_application.zip" ]; then
                cp "dfu_application.zip" "${PREFIX}-dfu.zip"
                echo "  âœ“ ${PREFIX}-dfu.zip (DFU package)"
              fi
              
              # Network core image (optional, for reference)
              if [ -f "ipc_radio/zephyr/zephyr.hex" ]; then
                cp "ipc_radio/zephyr/zephyr.hex" "${PREFIX}-net.hex"
                echo "  âœ“ ${PREFIX}-net.hex (Network core)"
              fi
              
              # Config file for debugging
              if [ -f "$APP_DIR/zephyr/.config" ]; then
                cp "$APP_DIR/zephyr/.config" "${PREFIX}.config"
                echo "  âœ“ ${PREFIX}.config"
              fi
              
              echo ""
              echo "âœ… All artifacts prepared"
              echo ""
              echo "ðŸ“¦ Final artifact list:"
              ls -lh ${PREFIX}-* 2>/dev/null || echo "  (No artifacts found with prefix)"
              
              echo ""
              echo "============================================"
              echo "âœ… BUILD COMPLETE"
              echo "============================================"
            '

      # ============================================================
      # STEP 4: Upload build logs on failure
      # ============================================================
      - name: ðŸ“¤ Upload Build Logs (on failure)
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: logs-${{ matrix.app.build_name }}-${{ github.run_number }}
          path: |
            project/${{ matrix.app.path }}/build.log
            project/${{ matrix.app.path }}/build/**/CMakeFiles/CMakeError.log
            project/${{ matrix.app.path }}/build/**/CMakeFiles/CMakeOutput.log
          retention-days: 7
          if-no-files-found: warn

      # ============================================================
      # STEP 5: Upload firmware artifacts on success
      # ============================================================
      - name: ðŸ“¦ Upload Firmware Artifacts
        if: success()
        uses: actions/upload-artifact@v4
        with:
          name: firmware-${{ matrix.app.build_name }}-${{ github.run_number }}
          path: |
            project/${{ matrix.app.path }}/build/${{ matrix.app.build_name }}-*
            project/${{ matrix.app.path }}/build/memory-*.txt
            project/${{ matrix.app.path }}/build.log
          retention-days: 30
          if-no-files-found: error

      # ============================================================
      # STEP 6: Build summary
      # ============================================================
      - name: ðŸ“ Build Summary
        if: always()
        run: |
          VERSION=$(cat version.txt 2>/dev/null || echo "${{ github.sha }}")
          
          cat >> $GITHUB_STEP_SUMMARY << EOF
          ## ${{ matrix.app.name }} - Build ${{ job.status }}
          
          | Property | Value |
          |----------|-------|
          | **Board** | ${{ env.BOARD }} |
          | **Version** | \`${VERSION}\` |
          | **NCS** | ${{ env.NCS_VERSION }} |
          | **Sysbuild** | âœ… Enabled (Multi-core) |
          | **Memfault** | âœ… Configured |
          | **Status** | **${{ job.status }}** |
          | **Run ID** | ${{ github.run_number }} |
          | **Artifact** | \`firmware-${{ matrix.app.build_name }}-${{ github.run_number }}\` |
          
          ### ðŸ“¦ Generated Files
          
          - \`${{ matrix.app.build_name }}-${VERSION}-merged.hex\` - **Flash this to device**
          - \`${{ matrix.app.build_name }}-${VERSION}-ota.bin\` - Use for BLE OTA updates
          - \`${{ matrix.app.build_name }}-${VERSION}-dfu.zip\` - DFU package for nRF Device Manager
          - \`${{ matrix.app.build_name }}-${VERSION}-app.elf\` - Debug symbols (for GDB)
          
          ### ðŸ“Š Build Info
          
          - **Trigger**: ${{ github.event_name }}
          - **Commit**: ${{ github.sha }}
          - **Branch**: ${{ github.ref_name }}
          - **Actor**: @${{ github.actor }}
          
          EOF
