name: Build nRF7002DK Firmware

on:
  push:
    branches: [main, master, develop]
    paths-ignore:
      - 'docs/**'
      - '**.md'
  pull_request:
  workflow_dispatch:

env:
  NCS_VERSION: v3.0.2
  BOARD: nrf7002dk/nrf5340/cpuapp

jobs:
  build:
    name: Build ${{ matrix.app.name }}
    runs-on: ubuntu-24.04
    timeout-minutes: 60

    strategy:
      fail-fast: false
      matrix:
        app:
          - name: "Root Main App"
            path: ""
            build_name: "root-app"
          - name: "Motion Sensor"
            path: "subroutines/Motion_sensor"
            build_name: "motion-sensor"
          - name: "BLE NUS"
            path: "subroutines/ble_nus"
            build_name: "ble-nus"
          - name: "Servo"
            path: "subroutines/servo"
            build_name: "servo"

    steps:
      # 1) Checkout into workspace subdir
      - name: ðŸ“¥ Checkout Repository
        uses: actions/checkout@v4
        with:
          path: zephyr-workspace/project
          fetch-depth: 0

      # 2) Install Zephyr host deps + west
      - name: ðŸ§° Install Dependencies + West
        run: |
          sudo apt update
          sudo apt install --no-install-recommends -y git cmake ninja-build gperf \
            ccache dfu-util device-tree-compiler wget \
            python3-dev python3-pip python3-setuptools python3-tk python3-wheel xz-utils file \
            make gcc gcc-multilib g++-multilib libsdl2-dev libmagic1
          pip3 install west

      # 3) Install Zephyr SDK minimal (arm only)
      - name: ðŸª Install Zephyr SDK
        run: |
          wget -q https://github.com/zephyrproject-rtos/sdk-ng/releases/download/v0.16.4/zephyr-sdk-0.16.4_linux-x86_64_minimal.tar.xz
          tar xf zephyr-sdk-0.16.4_linux-x86_64_minimal.tar.xz -C ~/
          ~/zephyr-sdk-0.16.4/setup.sh -c -t arm-zephyr-eabi
          echo "ZEPHYR_SDK_INSTALL_DIR=$HOME/zephyr-sdk-0.16.4" >> $GITHUB_ENV

      # 4) Initialize west workspace from your west.yml
      - name: â™»ï¸ Initialize NCS Workspace
        working-directory: zephyr-workspace
        run: |
          west init -l project
          west update --narrow -o=--depth=1
          pip3 install -r zephyr/scripts/requirements.txt
          pip3 install -r nrf/scripts/requirements-build.txt
          pip3 install -r bootloader/mcuboot/scripts/requirements.txt

      # 5) Set firmware version (per commit/tag)
      - name: ðŸ·ï¸ Set Firmware Version
        id: version
        working-directory: zephyr-workspace
        run: |
          if [[ "${{ github.ref }}" == refs/tags/v* ]]; then
            VERSION="${{ github.ref_name }}"
          else
            VERSION="$(git -C project rev-parse --short=8 HEAD)"
          fi
          echo "VERSION=$VERSION" >> $GITHUB_OUTPUT
          echo "VERSION=$VERSION" >> $GITHUB_ENV
          echo "ðŸ·ï¸  Firmware Version: $VERSION"

      # 6) Create Memfault overlay inside each app dir (host side)
      - name: ðŸ” Create Memfault Config
        working-directory: zephyr-workspace
        env:
          MEMFAULT_KEY: ${{ secrets.MEMFAULT_PROJECT_KEY }}
          FW_VERSION: ${{ steps.version.outputs.VERSION }}
        run: |
          APP_REL="${{ matrix.app.path }}"
          if [ -z "$APP_REL" ]; then
            APP_DIR="project"
          else
            APP_DIR="project/$APP_REL"
          fi

          cat > "$APP_DIR/overlay-memfault-ci.conf" << 'EOF'
          CONFIG_MEMFAULT=y
          CONFIG_MEMFAULT_SHELL=y
          CONFIG_MEMFAULT_LOGGING_ENABLE=y
          CONFIG_MEMFAULT_LOG_LEVEL_INF=y
          CONFIG_MEMFAULT_NCS_BT_METRICS=y
          CONFIG_MEMFAULT_NCS_PROJECT_KEY="__MEMFAULT_KEY__"
          CONFIG_MEMFAULT_NCS_FW_VERSION_STATIC=y
          CONFIG_MEMFAULT_NCS_FW_VERSION="__FW_VERSION__"
          CONFIG_MEMFAULT_NCS_FW_TYPE="ci-__BUILD_NAME__"
          CONFIG_MEMFAULT_NCS_DEVICE_ID_STATIC=y
          CONFIG_MEMFAULT_NCS_DEVICE_ID="ci-__BUILD_NAME__-dev01"
          CONFIG_HW_ID_LIBRARY=n
          CONFIG_BT_DIS=y
          CONFIG_BT_DIS_SERIAL_NUMBER=y
          CONFIG_BT_DIS_SERIAL_NUMBER_STR="ci-__BUILD_NAME__-dev01"
          CONFIG_BT_DIS_HW_REV=y
          CONFIG_BT_DIS_HW_REV_STR="nrf7002dk_nrf5340"
          CONFIG_BT_DIS_SW_REV=y
          CONFIG_BT_DIS_SW_REV_STR="main"
          CONFIG_BT_DIS_FW_REV=y
          CONFIG_BT_DIS_FW_REV_STR="__FW_VERSION__"
          CONFIG_MCUMGR_GRP_OS_INFO=y
          CONFIG_BT_SMP=y
          CONFIG_BT_SETTINGS=y
          CONFIG_FLASH_MAP=y
          CONFIG_STREAM_FLASH=y
          CONFIG_IMG_MANAGER=y
          CONFIG_DFU_TARGET=y
          CONFIG_DFU_TARGET_MCUBOOT=y
          CONFIG_HEAP_MEM_POOL_SIZE=4096
          EOF

          sed -i "s/__MEMFAULT_KEY__/$MEMFAULT_KEY/g" "$APP_DIR/overlay-memfault-ci.conf"
          sed -i "s/__FW_VERSION__/$FW_VERSION/g" "$APP_DIR/overlay-memfault-ci.conf"
          sed -i "s/__BUILD_NAME__/${{ matrix.app.build_name }}/g" "$APP_DIR/overlay-memfault-ci.conf"

          echo "âœ… Memfault overlay created at $APP_DIR/overlay-memfault-ci.conf"
          head -5 "$APP_DIR/overlay-memfault-ci.conf"

      # 7) Build app with west (no Docker)
      - name: ðŸ”§ Build Firmware
        working-directory: zephyr-workspace
        run: |
          APP_REL="${{ matrix.app.path }}"
          BUILD_NAME="${{ matrix.app.build_name }}"

          if [ -z "$APP_REL" ]; then
            APP_DIR="project"
          else
            APP_DIR="project/$APP_REL"
          fi

          BUILD_DIR="build-$BUILD_NAME"

          echo "ðŸ—ï¸  Building $BUILD_NAME from $APP_DIR into $BUILD_DIR"

          west build \
            -b ${{ env.BOARD }} \
            -d "$BUILD_DIR" \
            -p always \
            --sysbuild \
            "$APP_DIR" \
            -- -DEXTRA_CONF_FILE=overlay-memfault-ci.conf \
            2>&1 | tee "$BUILD_DIR/build.log"

      # 8) Debug: list build output
      - name: ðŸ” Debug List Build Output
        if: always()
        working-directory: zephyr-workspace
        run: |
          BUILD_DIR="build-${{ matrix.app.build_name }}"
          if [ -d "$BUILD_DIR" ]; then
            echo "=== Contents of $BUILD_DIR ==="
            ls -R "$BUILD_DIR" || true
            echo "=== Firmware files found ==="
            find "$BUILD_DIR" -type f \( -name "*.hex" -o -name "*.elf" -o -name "*.bin" -o -name "*.zip" \) || true
          else
            echo "âŒ Build directory $BUILD_DIR does not exist"
          fi

      # 9) Upload logs on failure
      - name: ðŸ“¤ Upload Build Logs (on failure)
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: logs-${{ matrix.app.build_name }}-${{ github.run_number }}
          path: |
            zephyr-workspace/build-${{ matrix.app.build_name }}/build.log
            zephyr-workspace/build-${{ matrix.app.build_name }}/**/CMakeFiles/CMakeError.log
          retention-days: 7
          if-no-files-found: warn

      # 10) Upload firmware artifacts on success
      - name: ðŸ“¦ Upload Firmware Artifacts
        if: success()
        uses: actions/upload-artifact@v4
        with:
          name: firmware-${{ matrix.app.build_name }}-${{ github.run_number }}
          path: |
            zephyr-workspace/build-${{ matrix.app.build_name }}/**/*.elf
            zephyr-workspace/build-${{ matrix.app.build_name }}/**/*.hex
            zephyr-workspace/build-${{ matrix.app.build_name }}/**/*.bin
            zephyr-workspace/build-${{ matrix.app.build_name }}/**/*.zip
            zephyr-workspace/build-${{ matrix.app.build_name }}/memory-*.txt
          retention-days: 30
          if-no-files-found: warn

      # 11) Build summary
      - name: ðŸ“ Build Summary
        if: always()
        run: |
          cat >> $GITHUB_STEP_SUMMARY << EOF
          ## ${{ matrix.app.name }} - ${{ job.status }}

          | Property | Value |
          |----------|-------|
          | **Board** | ${{ env.BOARD }} |
          | **Version** | \`${{ env.VERSION }}\` |
          | **NCS** | ${{ env.NCS_VERSION }} |
          | **Status** | **${{ job.status }}** |
          | **Artifact** | firmware-${{ matrix.app.build_name }}-${{ github.run_number }} |
          EOF
