name: Build nRF7002DK Firmware

on:
  push:
    branches: [main, master, develop]
    paths-ignore:
      - 'docs/**'
      - '**.md'
  pull_request:
  workflow_dispatch:

env:
  NCS_VERSION: v3.0.2
  BOARD: nrf7002dk/nrf5340/cpuapp
  DOCKER_IMAGE: ghcr.io/zephyrproject-rtos/ci:v0.27.4

jobs:
  prepare:
    name: Prepare Environment
    runs-on: ubuntu-24.04
    outputs:
      cache-key: ${{ steps.cache-key.outputs.key }}
    steps:
      - name: ðŸ“¥ Checkout
        uses: actions/checkout@v4
        with:
          path: project

      - name: ðŸ”‘ Generate Cache Key
        id: cache-key
        run: |
          KEY="west-modules-${{ env.NCS_VERSION }}-${{ hashFiles('project/west.yml') }}"
          echo "key=$KEY" >> $GITHUB_OUTPUT

      - name: ðŸ§¹ Free Disk Space
        run: |
          sudo rm -rf /usr/share/dotnet
          sudo rm -rf /usr/local/lib/android
          sudo rm -rf /opt/ghc
          sudo rm -rf /opt/hostedtoolcache/CodeQL
          sudo apt-get clean

      - name: ðŸ³ Pull Docker Image
        run: docker pull ${{ env.DOCKER_IMAGE }}

  build:
    name: Build ${{ matrix.app.name }}
    runs-on: ubuntu-24.04
    needs: prepare
    timeout-minutes: 60
    
    strategy:
      fail-fast: false
      matrix:
        app:
          - name: "Root Main App"
            path: ""
            build_name: "root-app"
          
          - name: "Motion Sensor"
            path: "subroutines/Motion_sensor"
            build_name: "motion-sensor"
          
          - name: "BLE NUS"
            path: "subroutines/ble_nus"
            build_name: "ble-nus"
          
          - name: "Servo"
            path: "subroutines/servo"
            build_name: "servo"

    steps:
      - name: ðŸ“¥ Checkout Repository
        uses: actions/checkout@v4
        with:
          path: project
          fetch-depth: 0

      - name: ðŸ§¹ Free Disk Space
        run: |
          sudo rm -rf /usr/share/dotnet
          sudo rm -rf /usr/local/lib/android
          sudo rm -rf /opt/ghc
          sudo apt-get clean
          docker system prune -af

      - name: ðŸ’¾ Cache West Modules
        id: cache-west
        uses: actions/cache@v4
        with:
          path: |
            modules
            zephyr
            nrf
            bootloader
            tools
          key: ${{ needs.prepare.outputs.cache-key }}
          restore-keys: |
            west-modules-${{ env.NCS_VERSION }}-

      - name: ðŸ·ï¸ Set Firmware Version
        id: version
        run: |
          cd project
          if [[ "${{ github.ref }}" == refs/tags/v* ]]; then
            VERSION="${{ github.ref_name }}"
          else
            VERSION="$(git rev-parse --short=8 HEAD)"
          fi
          echo "VERSION=$VERSION" >> $GITHUB_OUTPUT
          echo "VERSION=$VERSION" >> $GITHUB_ENV
          echo "ðŸ·ï¸  Firmware Version: $VERSION"

      - name: ðŸ”§ Initialize & Build
        env:
          MEMFAULT_KEY: ${{ secrets.MEMFAULT_PROJECT_KEY }}
          VERSION: ${{ steps.version.outputs.VERSION }}
        run: |
          APP_PATH="${{ matrix.app.path }}"
          if [ -z "$APP_PATH" ]; then
            APP_PATH="."
          fi
          
          echo "Building app at: $APP_PATH"
          
          docker run --rm \
            -v "$(pwd):/workdir" \
            -w /workdir \
            -e MEMFAULT_KEY="${MEMFAULT_KEY}" \
            -e APP_PATH="${APP_PATH}" \
            -e BUILD_NAME="${{ matrix.app.build_name }}" \
            -e VERSION="${VERSION}" \
            ${{ env.DOCKER_IMAGE }} \
            bash -c '
              set -e
              export CMAKE_PREFIX_PATH=/opt/toolchains
              
              echo "============================================"
              echo "ðŸš€ CI/CD Build Pipeline"
              echo "============================================"
              echo "ðŸ“¦ NCS: ${{ env.NCS_VERSION }}"
              echo "ðŸ“‹ Board: ${{ env.BOARD }}"
              echo "ðŸ—ï¸  App: ${{ matrix.app.name }}"
              echo "ðŸ·ï¸  Version: ${VERSION}"
              echo "============================================"
              
              cd /workdir/project
              
              echo ""
              echo "ðŸ”§ Initializing West..."
              west init -l .
              
              if [ "${{ steps.cache-west.outputs.cache-hit }}" != "true" ]; then
                echo "ðŸ“¦ Fetching NCS modules..."
                west update -o=--depth=1 -n
                west blobs fetch hal_nordic
              else
                echo "âœ… Using cached modules"
              fi
              
              west zephyr-export
              
              echo ""
              echo "ðŸ“¦ Installing dependencies..."
              pip3 install --no-cache-dir -q \
                -r ../nrf/scripts/requirements-build.txt \
                -r ../zephyr/scripts/requirements.txt \
                -r ../bootloader/mcuboot/scripts/requirements.txt
              
              cd "${APP_PATH}"
              
              echo ""
              echo "ðŸ” Configuring Memfault..."
              cat > overlay-memfault-ci.conf << "OVERLAY_EOF"
            CONFIG_MEMFAULT=y
            CONFIG_MEMFAULT_SHELL=y
            CONFIG_MEMFAULT_LOGGING_ENABLE=y
            CONFIG_MEMFAULT_LOG_LEVEL_INF=y
            CONFIG_MEMFAULT_NCS_BT_METRICS=y
            CONFIG_MEMFAULT_NCS_PROJECT_KEY="MEMFAULT_KEY_PLACEHOLDER"
            CONFIG_MEMFAULT_NCS_FW_VERSION_STATIC=y
            CONFIG_MEMFAULT_NCS_FW_VERSION="VERSION_PLACEHOLDER"
            CONFIG_MEMFAULT_NCS_FW_TYPE="ci-${BUILD_NAME}"
            CONFIG_MEMFAULT_NCS_DEVICE_ID_STATIC=y
            CONFIG_MEMFAULT_NCS_DEVICE_ID="ci-${BUILD_NAME}-dev01"
            CONFIG_HW_ID_LIBRARY=n
            CONFIG_BT_DIS=y
            CONFIG_BT_DIS_SERIAL_NUMBER=y
            CONFIG_BT_DIS_SERIAL_NUMBER_STR="ci-${BUILD_NAME}-dev01"
            CONFIG_BT_DIS_HW_REV=y
            CONFIG_BT_DIS_HW_REV_STR="nrf7002dk_nrf5340"
            CONFIG_BT_DIS_SW_REV=y
            CONFIG_BT_DIS_SW_REV_STR="main"
            CONFIG_BT_DIS_FW_REV=y
            CONFIG_BT_DIS_FW_REV_STR="VERSION_PLACEHOLDER"
            CONFIG_MCUMGR_GRP_OS_INFO=y
            CONFIG_BT_SMP=y
            CONFIG_BT_SETTINGS=y
            CONFIG_FLASH_MAP=y
            CONFIG_STREAM_FLASH=y
            CONFIG_IMG_MANAGER=y
            CONFIG_DFU_TARGET=y
            CONFIG_DFU_TARGET_MCUBOOT=y
            CONFIG_HEAP_MEM_POOL_SIZE=4096
            OVERLAY_EOF
              
              sed -i "s/MEMFAULT_KEY_PLACEHOLDER/${MEMFAULT_KEY}/g" overlay-memfault-ci.conf
              sed -i "s/VERSION_PLACEHOLDER/${VERSION}/g" overlay-memfault-ci.conf
              
              echo "âœ… Memfault configured"
              
              echo ""
              echo "============================================"
              echo "ðŸ”¨ Building..."
              echo "============================================"
              
              west build \
                -b ${{ env.BOARD }} \
                -p always \
                --sysbuild \
                -- -DEXTRA_CONF_FILE=overlay-memfault-ci.conf \
                2>&1 | tee build.log
              
              if [ $? -ne 0 ]; then
                echo "âŒ BUILD FAILED"
                exit 1
              fi
              
              echo "âœ… BUILD SUCCEEDED"
              
              cd build
              
              APP_DIR=$(find . -maxdepth 2 -type f -name "zephyr.elf" -print -quit | xargs dirname | xargs dirname 2>/dev/null || echo ".")
              
              if [ -f "$APP_DIR/zephyr/zephyr.elf" ]; then
                echo "ðŸ“Š Memory (App Core):"
                arm-zephyr-eabi-size "$APP_DIR/zephyr/zephyr.elf" | tee memory-app.txt
              fi
              
              if [ -f "ipc_radio/zephyr/zephyr.elf" ]; then
                echo "ðŸ“Š Memory (Net Core):"
                arm-zephyr-eabi-size "ipc_radio/zephyr/zephyr.elf" | tee memory-net.txt
              fi
              
              echo ""
              echo "ðŸ“¦ Build artifacts:"
              find . -name "*.hex" -o -name "*.elf" -o -name "*.bin" -o -name "*.zip" | head -20
            '

      - name: ðŸ“¤ Upload Build Logs (on failure)
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: logs-${{ matrix.app.build_name }}-${{ github.run_number }}
          path: |
            ${{ matrix.app.path == '' && 'project/build.log' || format('project/{0}/build.log', matrix.app.path) }}
            ${{ matrix.app.path == '' && 'project/build/**/CMakeFiles/CMakeError.log' || format('project/{0}/build/**/CMakeFiles/CMakeError.log', matrix.app.path) }}
          retention-days: 7
          if-no-files-found: warn

      - name: ðŸ“¦ Upload Firmware Artifacts
        if: success()
        uses: actions/upload-artifact@v4
        with:
          name: firmware-${{ matrix.app.build_name }}-${{ github.run_number }}
          path: |
            ${{ matrix.app.path == '' && 'project/build/*/zephyr/zephyr.elf' || format('project/{0}/build/*/zephyr/zephyr.elf', matrix.app.path) }}
            ${{ matrix.app.path == '' && 'project/build/*/zephyr/zephyr.hex' || format('project/{0}/build/*/zephyr/zephyr.hex', matrix.app.path) }}
            ${{ matrix.app.path == '' && 'project/build/merged.hex' || format('project/{0}/build/merged.hex', matrix.app.path) }}
            ${{ matrix.app.path == '' && 'project/build/dfu_application.zip' || format('project/{0}/build/dfu_application.zip', matrix.app.path) }}
            ${{ matrix.app.path == '' && 'project/build/*/zephyr/app_update.bin' || format('project/{0}/build/*/zephyr/app_update.bin', matrix.app.path) }}
            ${{ matrix.app.path == '' && 'project/build/*/zephyr/zephyr.signed.bin' || format('project/{0}/build/*/zephyr/zephyr.signed.bin', matrix.app.path) }}
            ${{ matrix.app.path == '' && 'project/build/memory-*.txt' || format('project/{0}/build/memory-*.txt', matrix.app.path) }}
          retention-days: 30
          if-no-files-found: warn

      - name: ðŸ“ Build Summary
        if: always()
        run: |
          cat >> $GITHUB_STEP_SUMMARY << EOF
          ## ${{ matrix.app.name }} - ${{ job.status }}
          
          | Property | Value |
          |----------|-------|
          | **Board** | ${{ env.BOARD }} |
          | **Version** | \`${{ env.VERSION }}\` |
          | **NCS** | ${{ env.NCS_VERSION }} |
          | **Status** | **${{ job.status }}** |
          | **Artifact** | firmware-${{ matrix.app.build_name }}-${{ github.run_number }} |
          
          ### ðŸ“¦ Flash Command
          \`\`\`bash
          nrfjprog --program merged.hex --chiperase --reset
          \`\`\`
          EOF
